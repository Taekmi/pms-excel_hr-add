# pms_excel_app.py â€” Project Management System (Excel Prototype, Streamlit)
# =============================================================================
# í•µì‹¬ ë³€ê²½/ê°œì„  ìš”ì•½
# - ë¬¸ìì—´/ì˜µì…˜ ì•ˆì „í™”: _s, safe_select_options, safe_fmt_by ë¡œ ëª¨ë“  selectbox ì•ˆì „ë³´ì¥
# - ë‚ ì§œ ìœ íš¨ì„± ì „ì—­ ì ìš©: end >= start (Projects/Tasks/Contracts/CSV Import)
# - íŒŒì¼ ê²½ë¡œ ì¼ì›í™”: BASE_DIR ê³ ì • + os.chdir(BASE_DIR) â†’ app/app ì¬ê·€ ë°©ì§€
# - ê¸°ì¡´ Excel ìŠ¤í‚¤ë§ˆ ìë™ ë³´ì •(ë§ˆì´ê·¸ë ˆì´ì…˜): NaN/NaT â†’ "" ë° dtype ê°•ì œ
# - Streamlit ê²½ê³  ì œê±°: use_container_width â†’ width='stretch'
# - Contracts: ì—…ë¡œë“œ ë””ìŠ¤í¬ ì €ì¥ + Excel ë©”íƒ€ ê¸°ë¡ + ì„ íƒ ZIP ë‹¤ìš´ë¡œë“œ + ì‚­ì œ ë™ê¸°í™”
# - HR/Timesheets ìŠ¤í‚¤ë§ˆ í†µì¼(HR íƒ­ ì½”ë“œì™€ 1:1 ì¼ì¹˜)
# =============================================================================

# --- ê²½ë¡œ/ìƒìˆ˜ ---
import os, sys
from pathlib import Path

if getattr(sys, 'frozen', False):  # pyinstaller ë“±
    BASE_DIR = Path(sys.executable).resolve().parent
else:
    BASE_DIR = Path(__file__).resolve().parent

DATA_FILE = str((BASE_DIR / "pms_data.xlsx").resolve())
LOCK_FILE = DATA_FILE + ".lock"
UPLOAD_ROOT = str((BASE_DIR / "uploads").resolve())

SHEET_PROJECTS        = "Projects"
SHEET_TASKS           = "Tasks"
SHEET_COMMENTS        = "Comments"
SHEET_META            = "Meta"
SHEET_CONTRACTS       = "Contracts"
SHEET_BILLINGS        = "Billings"
SHEET_CONTRACT_FILES  = "ContractFiles"
SHEET_HUMANRES        = "HumanResources"
SHEET_TIMESHEETS      = "Timesheets"

TASK_STATUS_OPTIONS    = ["To Do", "In Progress", "Blocked", "Done"]
TASK_PRIORITY_OPTIONS  = ["Low", "Medium", "High", "Critical"]
PROJECT_STATUS_OPTIONS = ["Planned", "Active", "On Hold", "Closed"]
BILL_ITEM_OPTIONS      = ["ê³„ì•½ê¸ˆ", "ì¤‘ë„ê¸ˆ", "ì”ê¸ˆ"]
YN_OPTIONS             = ["N", "Y"]
CONTRACT_STATUS_OPTIONS = ["ì‘ì„±ì¤‘", "ì²´ê²°ì™„ë£Œ", "ì§„í–‰ì¤‘", "ë³€ê²½", "ì¡°ê¸°ì¢…ë£Œ(ì¤‘ë„í•´ì§€)", "ì¢…ë£Œ"]

SESSION_PREFIX = "pmsx"
def k(*parts): return f"{SESSION_PREFIX}_" + "_".join(map(lambda x: str(x).replace(' ', '_'), parts))

import re
import io
import zipfile
import hashlib
from datetime import datetime, date, timedelta
from dateutil.parser import parse as parse_dt

import numpy as np
import pandas as pd
from filelock import FileLock
import streamlit as st
import plotly.express as px
import streamlit.components.v1 as components

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë¬¸ìì—´/ì˜µì…˜ ì•ˆì „ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _s(x) -> str:
    try:
        if x is None:
            return ""
        s = str(x).strip()
        return "" if s.lower() in ("nan", "nat") else s
    except Exception:
        return ""

def safe_select_options(series: pd.Series) -> list[str]:
    if series is None or len(series) == 0:
        return []
    vals = series.astype(object).map(_s).tolist()
    return [v for v in vals if v]

def safe_fmt_by(df: pd.DataFrame, key_col: str, value_col: str):
    def _fmt(x):
        try:
            kcol = df.get(key_col)
            if kcol is None:
                return _s(x)
            mask = kcol.astype(object).map(_s) == _s(x)
            if mask.any():
                val = df.loc[mask, value_col].iloc[0] if value_col in df.columns else ""
                sv = _s(val)
                return sv if sv else _s(x)
            return _s(x)
        except Exception:
            return _s(x)
    return _fmt

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê³µí†µ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _now_iso(): return datetime.now().strftime("%Y-%m-%d %H:%M:%S")

def _safe_date_str(d):
    if pd.isna(d) or d is None: return ""
    if isinstance(d, (datetime, date)): return d.strftime("%Y-%m-%d")
    try: return parse_dt(str(d)).strftime("%Y-%m-%d")
    except Exception: return ""

def _parse_date_maybe(d):
    s = _safe_date_str(d)
    if not s: return None
    try:
        return parse_dt(s).date()
    except Exception:
        return None

def _to_dt_or_nat(x):
    try: return pd.to_datetime(x) if str(x).strip() else pd.NaT
    except Exception: return pd.NaT

def _parse_int_from_krw_strict(s):
    if s is None: return 0
    s = "".join(ch for ch in str(s) if ch.isdigit())
    if s == "": return 0
    try: return int(s)
    except Exception: return 0

def scroll_to(anchor_id: str, offset: int = 72):
    components.html(
        f"""
        <script>
        (function() {{
          function tryScroll(rootDoc) {{
            if (!rootDoc) return false;
            var el = rootDoc.getElementById("{anchor_id}");
            if (!el) return false;
            try {{ el.scrollIntoView({{ behavior: 'smooth', block: 'start' }}); }} catch(e) {{}}
            var rect = el.getBoundingClientRect();
            var top = rect.top + (rootDoc.defaultView ? rootDoc.defaultView.pageYOffset : window.pageYOffset) - {offset};
            var targets = [rootDoc.scrollingElement, rootDoc.querySelector('[data-testid="stAppViewContainer"]'), rootDoc.querySelector('section.main'), rootDoc.body].filter(Boolean);
            for (var i=0;i<targets.length;i++) {{ try {{ targets[i].scrollTo({{top: top, left: 0, behavior:'smooth'}}); return true; }} catch(e){{}} }}
            try {{ (rootDoc.defaultView || window).scrollTo({{top: top, left:0, behavior:'smooth'}}); return true; }}
            catch(e){{}}
            try {{ if (window.parent && window.parent!==window) {{ window.parent.scrollTo({{top: top, left:0, behavior:'smooth'}}); return true; }} }} catch(e){{}}
            return false;
          }}
          function go() {{
            if (tryScroll(document)) return true;
            try {{ if (window.parent && window.parent.document) return tryScroll(window.parent.document); }} catch(e){{}}
            return false;
          }}
          if (!go()) setTimeout(go, 80);
          if (!go()) setTimeout(go, 240);
          if (!go()) setTimeout(go, 600);
        }})();
        </script>
        """,
        height=1,
    )

def _files_signature(files):
    if not files: return None
    sig_parts = []
    for f in files:
        try: b = f.getbuffer()
        except Exception: b = bytes(str(f.name), "utf-8")
        b = bytes(b)
        sig_parts.append((f.name, len(b), hashlib.sha1(b[:1024*1024]).hexdigest()))
    return tuple(sorted(sig_parts))

def business_days_inclusive(start_d: date, end_d: date) -> int:
    if start_d is None or end_d is None: return 0
    s, e = (start_d, end_d) if start_d <= end_d else (end_d, start_d)
    s64, e64 = np.datetime64(s), np.datetime64(e)
    count = np.busday_count(s64, e64) + (1 if np.is_busday(e64) else 0)
    return int(max(0, count))














# ===== Timesheet helpers (DROP-IN REPLACEMENT) =====
from datetime import date, timedelta
import pandas as pd

def _s(x) -> str:
    try:
        if x is None: return ""
        s = str(x).strip()
        return "" if s.lower() in ("nan", "nat") else s
    except Exception:
        return ""

def _monday(d: date | None) -> date:
    if d is None:
        d = date.today()
    return d - timedelta(days=d.weekday())

def _block_bounds(proj_start: date | None, proj_end: date | None) -> tuple[date, date]:
    """ì‹œì‘ì¼ ê¸°ì¤€ -5ì£¼, ì¢…ë£Œì¼ ê¸°ì¤€ +52ì£¼ë¡œ í™•ì¥."""
    ps = _monday(proj_start or date.today())
    pe = _monday(proj_end   or (proj_start or date.today()))
    if pe < ps:
        ps, pe = pe, ps
    return ps - timedelta(weeks=5), pe + timedelta(weeks=52)

def _block_start_mondays(proj_start: date | None, proj_end: date | None) -> list[date]:
    """52ì£¼ì§œë¦¬ ë¸”ë¡ ì‹œì‘ ì›”ìš”ì¼ë“¤(ìµœì†Œ 1ê°œ)."""
    ms, me = _block_bounds(proj_start, proj_end)
    blocks, cur = [], ms
    while cur <= me:
        blocks.append(cur)
        cur = cur + timedelta(weeks=52)
    if not blocks:
        blocks = [_monday(date.today()) - timedelta(weeks=5)]
    return blocks

def _week_mondays_of_block(block_start: date) -> list[date]:
    """í•´ë‹¹ ë¸”ë¡ì˜ 52ê°œ ì£¼ ì‹œì‘ì¼(ì›”ìš”ì¼)."""
    return [block_start + timedelta(weeks=i) for i in range(52)]

# def _normalize_ts(ts: pd.DataFrame) -> pd.DataFrame:
#     """block_startë¥¼ dateë¡œ íŒŒì‹±í•´ '_block_date'ì— ë³´ê´€ (ì›ë³¸ì€ ë¬¸ìì—´ ê·¸ëŒ€ë¡œ)."""
#     if ts is None or ts.empty:
#         return pd.DataFrame(columns=["project_id","member_name","block_start","_block_date"])
#     out = ts.copy()
#     out["_block_date"] = pd.to_datetime(out.get("block_start",""), errors="coerce").dt.date
#     return out


def _normalize_ts(ts: pd.DataFrame) -> pd.DataFrame:
    """
    Timesheets ì •ê·œí™”:
    - í•„ìˆ˜ ì»¬ëŸ¼(project_id, member_name, block_start) ë³´ì¥
    - block_start -> '_block_date'(date) íŒŒìƒ
    - ww1~ww53 ìˆ«ì(float) ê°•ì œ, ê²°ì¸¡ì€ 0.0
    """
    df = ts.copy() if isinstance(ts, pd.DataFrame) else pd.DataFrame()

    # í•„ìˆ˜ ì»¬ëŸ¼
    for c in ["project_id", "member_name", "block_start"]:
        if c not in df.columns:
            df[c] = ""

    # ë¬¸ìì—´ ì•ˆì „í™”
    df["project_id"]  = df["project_id"].astype(object).map(_s)
    df["member_name"] = df["member_name"].astype(object).map(_s)
    df["block_start"] = df["block_start"].astype(object).map(_s)

    # ë‚ ì§œ íŒŒìƒ
    df["_block_date"] = pd.to_datetime(df["block_start"], errors="coerce").dt.date

    # ww1~ww53 ìˆ«ìí™”(ì—†ìœ¼ë©´ ìƒì„±)
    for i in range(1, 54):
        col = f"ww{i}"
        if col not in df.columns:
            df[col] = 0.0
        else:
            df[col] = pd.to_numeric(df[col], errors="coerce").fillna(0.0).astype(float)

    return df




def _pick_block_for_date(blocks: list[date], d: date) -> date:
    """ë‚ ì§œ dë¥¼ í¬í•¨í•˜ëŠ” ë¸”ë¡(ì—†ìœ¼ë©´ ê°€ì¥ ê°€ê¹Œìš´ ë¸”ë¡ ì‹œì‘ì¼) ì„ íƒ."""
    if not blocks:
        return _monday(d)
    for b in blocks:
        # ë¸”ë¡ ë²”ìœ„: [b, b + 52ì£¼)  (52ì£¼ = 364ì¼)
        if b <= d < b + timedelta(weeks=52):
            return b
    return min(blocks, key=lambda x: abs((x - d).days))

def _ensure_timesheet_blocks(
    df_ts: pd.DataFrame,
    proj_id: str,
    member: str,
    proj_start: date | None,
    proj_end: date | None
) -> pd.DataFrame:
    """
    í”„ë¡œì íŠ¸ start/end ê¸°ì¤€ìœ¼ë¡œ -26ì£¼ ~ +52ì£¼ í™•ì¥í•œ '52ì£¼ ë¸”ë¡'ì„
    memberì— ëŒ€í•´ ëª¨ë‘ ë³´ì¥ ìƒì„±.
    - ìƒˆ í–‰ì˜ ww1..ww52ëŠ” float(0.0).
    - block_startëŠ” 'YYYY-MM-DD' ë¬¸ìì—´ë¡œ ì €ì¥.
    """
    if not member:
        return df_ts

    df = (df_ts.copy() if isinstance(df_ts, pd.DataFrame) else pd.DataFrame())
    # ìµœì†Œ ìŠ¤í‚¤ë§ˆ ë³´ì¥
    need = ["project_id","member_name","block_start"] + [f"ww{i}" for i in range(1,53)]
    for c in need:
        if c not in df.columns:
            df[c] = 0.0 if c.startswith("ww") else ""

    blocks = _block_start_mondays(proj_start, proj_end)
    df_norm = _normalize_ts(df)
    pid, mem = str(proj_id), _s(member)

    for b in blocks:
        exists = df_norm[
            (df_norm["project_id"].astype(str) == pid) &
            (df_norm["member_name"].astype(str) == mem) &
            (df_norm["_block_date"] == b)
        ]
        if exists.empty:
            row = {"project_id": pid, "member_name": mem, "block_start": b.strftime("%Y-%m-%d")}
            for i in range(1,53):
                row[f"ww{i}"] = 0.0
            df.loc[len(df)] = row

    # ëª¨ë“  ww ì»¬ëŸ¼ì„ floatìœ¼ë¡œ ê°•ì œ (0.25ê°€ 0ìœ¼ë¡œ ì €ì¥ë˜ëŠ” ì´ìŠˆ ë°©ì§€)
    for i in range(1,53):
        col = f"ww{i}"
        df[col] = pd.to_numeric(df_ts[col], errors="coerce").fillna(0.0).astype(float)

    return df.drop(columns=["_block_date"], errors="ignore")

def _cascade_delete_timesheets(df_ts: pd.DataFrame, proj_id: str, member_names: list[str]) -> pd.DataFrame:
    """HRì—ì„œ ì¸ë ¥ ì‚­ì œ ì‹œ, í•´ë‹¹ í”„ë¡œì íŠ¸/í•´ë‹¹ ì¸ë ¥ì˜ íƒ€ì„ì‹œíŠ¸ í–‰ì„ ì „ë¶€ ì œê±°"""
    if df_ts is None or df_ts.empty or not member_names:
        return df_ts
    pid = str(proj_id)
    nm_set = set(_s(n) for n in member_names if _s(n))
    mask_keep = ~(
        (df_ts["project_id"].astype(str) == pid) &
        (df_ts["member_name"].astype(str).map(_s).isin(nm_set))
    )
    return df_ts[mask_keep].copy()




# ===== /Timesheet helpers =====


























# â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì´ˆê¸°í™”/ì…ì¶œë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _ensure_excel_initialized():
    """ì—‘ì…€ íŒŒì¼/ì‹œíŠ¸ê°€ ì—†ìœ¼ë©´ ìƒì„±. uploads í´ë” ìƒì„±."""
    if not os.path.exists(DATA_FILE):
        with pd.ExcelWriter(DATA_FILE, engine="openpyxl") as w:
            pd.DataFrame(columns=[
                "project_id","project_code","name","owner","sponsor","status",
                "contract_amount","start_date","end_date","created_at","updated_at"
            ]).to_excel(w, index=False, sheet_name=SHEET_PROJECTS)

            pd.DataFrame(columns=[
                "task_id","project_id","parent_task_id","title","description","assignee",
                "priority","status","start_date","due_date","estimate_days","labels",
                "progress"
            ]).to_excel(w, index=False, sheet_name=SHEET_TASKS)

            pd.DataFrame(columns=[
                "comment_id","entity_type","entity_id","author","body","created_at"
            ]).to_excel(w, index=False, sheet_name=SHEET_COMMENTS)

            pd.DataFrame({
                "key":   ["project_id_seq","task_id_seq","comment_id_seq","bill_id_seq","file_id_seq"],
                "value": [1,1,1,1,1]
            }).to_excel(w, index=False, sheet_name=SHEET_META)

            pd.DataFrame(columns=[
                "contract_id","project_id","contractor","customer","contract_name",
                "period_start","period_end","contract_amount","contract_status",
                "created_at","updated_at"
            ]).to_excel(w, index=False, sheet_name=SHEET_CONTRACTS)

            pd.DataFrame(columns=[
                "bill_id","project_id","item","amount","due_date","request","note",
                "created_at","updated_at"
            ]).to_excel(w, index=False, sheet_name=SHEET_BILLINGS)

            # âœ… HR ìŠ¤í‚¤ë§ˆ (HR íƒ­ê³¼ 1:1)
            pd.DataFrame(columns=[
                "no","project_id","project_name","member_name","dept_role","grade_skill",
                "start_date","end_date","ratio","plan_mm","real_mm","wage",
                "plan_cost","real_cost","role","main_task","mm_diff","cost_diff","note"
            ]).to_excel(w, index=False, sheet_name=SHEET_HUMANRES)

            # âœ… Timesheets ìŠ¤í‚¤ë§ˆ (ts_id ì—†ìŒ)
            pd.DataFrame(columns=["project_id","member_name","block_start"] + [f"ww{i}" for i in range(1,53)]
            ).to_excel(w, index=False, sheet_name=SHEET_TIMESHEETS)

            pd.DataFrame(columns=[
                "file_id","project_id","filename","path","note","uploaded_at","file_hash"
            ]).to_excel(w, index=False, sheet_name=SHEET_CONTRACT_FILES)

    os.makedirs(UPLOAD_ROOT, exist_ok=True)

def _with_lock(fn, *args, **kwargs):
    with FileLock(LOCK_FILE, timeout=10):
        return fn(*args, **kwargs)

def _read_all():
    def _read():
        xl = pd.ExcelFile(DATA_FILE)
        p  = pd.read_excel(xl, sheet_name=SHEET_PROJECTS)
        t  = pd.read_excel(xl, sheet_name=SHEET_TASKS)
        c  = pd.read_excel(xl, sheet_name=SHEET_COMMENTS)
        m  = pd.read_excel(xl, sheet_name=SHEET_META)
        ct = pd.read_excel(xl, sheet_name=SHEET_CONTRACTS) if SHEET_CONTRACTS in xl.sheet_names else pd.DataFrame()
        bl = pd.read_excel(xl, sheet_name=SHEET_BILLINGS)  if SHEET_BILLINGS  in xl.sheet_names else pd.DataFrame()
        cf = pd.read_excel(xl, sheet_name=SHEET_CONTRACT_FILES) if SHEET_CONTRACT_FILES in xl.sheet_names else pd.DataFrame()
        hr = pd.read_excel(xl, sheet_name=SHEET_HUMANRES) if SHEET_HUMANRES in xl.sheet_names else pd.DataFrame()
        ts = pd.read_excel(xl, sheet_name=SHEET_TIMESHEETS) if SHEET_TIMESHEETS in xl.sheet_names else pd.DataFrame()
        return p, t, c, m, ct, bl, cf, hr, ts
    return _with_lock(_read)

def _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts):
    def _write():
        with pd.ExcelWriter(DATA_FILE, engine="openpyxl", mode="w") as w:
            df_p.to_excel(w, index=False, sheet_name=SHEET_PROJECTS)
            df_t.to_excel(w, index=False, sheet_name=SHEET_TASKS)
            df_c.to_excel(w, index=False, sheet_name=SHEET_COMMENTS)
            df_m.to_excel(w, index=False, sheet_name=SHEET_META)
            df_ct.to_excel(w, index=False, sheet_name=SHEET_CONTRACTS)
            df_bl.to_excel(w, index=False, sheet_name=SHEET_BILLINGS)
            df_cf.to_excel(w, index=False, sheet_name=SHEET_CONTRACT_FILES)
            df_hr.to_excel(w, index=False, sheet_name=SHEET_HUMANRES)
            df_ts.to_excel(w, index=False, sheet_name=SHEET_TIMESHEETS)
    _with_lock(_write)

def _next_id(df_meta, key):
    row = df_meta.loc[df_meta["key"] == key]
    if row.empty:
        df_meta.loc[len(df_meta)] = {"key": key, "value": 1}
        return 1, df_meta
    val = int(row["value"].values[0])
    df_meta.loc[df_meta["key"] == key, "value"] = val + 1
    return val, df_meta

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë§ˆì´ê·¸ë ˆì´ì…˜/ë³´ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€
TASK_ID_RE = re.compile(r"^(?P<pid>.+)_tsk_(?P<num>\d{3})$")

def _next_project_task_id(df_t: pd.DataFrame, project_id: str) -> str:
    proj = _s(project_id)
    sufmax = 0
    if not df_t.empty and "task_id" in df_t.columns:
        subset = df_t[df_t.get("project_id", "").astype(str) == proj]["task_id"].astype(str)
        for tid in subset:
            m = TASK_ID_RE.match(str(tid))
            if m and m.group("pid") == proj:
                sufmax = max(sufmax, int(m.group("num")))
    return f"{proj}_tsk_{sufmax+1:03d}"

def _normalize_task_ids(df_t: pd.DataFrame) -> tuple[pd.DataFrame, bool]:
    if df_t is None or df_t.empty: return df_t, False
    changed = False
    df_t = df_t.copy()
    for col in ["project_id","task_id"]:
        if col not in df_t.columns:
            df_t[col] = ""
            changed = True
    df_t["project_id"] = df_t["project_id"].astype(object).map(_s)
    df_t["task_id"]    = df_t["task_id"].astype(object).map(_s)

    for idx, row in df_t.iterrows():
        pid = _s(row.get("project_id",""))
        tid = _s(row.get("task_id",""))
        if not pid: continue
        m = TASK_ID_RE.match(tid)
        if m and m.group("pid") == pid:
            continue
        new_tid = _next_project_task_id(df_t, pid)
        if new_tid != tid:
            df_t.at[idx, "task_id"] = new_tid
            changed = True
    return df_t, changed

def _renumber_project_tasks(df_t: pd.DataFrame, df_c: pd.DataFrame, project_id: str) -> tuple[pd.DataFrame, pd.DataFrame]:
    pid = _s(project_id)
    tsub = df_t[df_t["project_id"].astype(str) == pid].copy()
    if tsub.empty: return df_t, df_c
    tsub["_sd"] = pd.to_datetime(tsub.get("start_date",""), errors="coerce")
    tsub["_dd"] = pd.to_datetime(tsub.get("due_date",""), errors="coerce")
    tsub = tsub.sort_values(by=["_sd","_dd","task_id"], ascending=[True,True,True]).drop(columns=["_sd","_dd"])
    mapping = {}
    counter = 1
    for idx in tsub.index:
        old_tid = _s(df_t.at[idx, "task_id"])
        new_tid = f"{pid}_tsk_{counter:03d}"
        if new_tid != old_tid:
            mapping[old_tid] = new_tid
            df_t.at[idx, "task_id"] = new_tid
        counter += 1
    if mapping and not df_c.empty and "entity_type" in df_c.columns and "entity_id" in df_c.columns:
        mask = df_c["entity_type"].astype(object).map(_s).str.lower().eq("task") & df_c["entity_id"].astype(object).map(_s).isin(mapping.keys())
        if mask.any():
            df_c.loc[mask, "entity_id"] = df_c.loc[mask, "entity_id"].astype(object).map(_s).map(lambda x: mapping.get(x, x))
    return df_t, df_c

def _migrate_schema(df_p, df_t, df_c, df_ct, df_bl, df_cf, df_hr, df_ts):
    changed = False

    # Projects
    for col, default in [("sponsor",""), ("contract_amount",0), ("created_at",""), ("updated_at","")]:
        if col not in df_p.columns:
            df_p[col] = default; changed = True
    for col in ["project_id","project_code","name","owner","sponsor","status","start_date","end_date","created_at","updated_at"]:
        if col in df_p.columns:
            df_p[col] = df_p[col].astype(object).map(_s)
    df_p["contract_amount"] = pd.to_numeric(df_p.get("contract_amount", 0), errors="coerce").fillna(0).astype(int)

    # Tasks
    req = ["project_id","task_id","title","description","assignee","priority","status","start_date","due_date","estimate_days","labels","progress","parent_task_id"]
    for col in req:
        if col not in df_t.columns:
            df_t[col] = "" if col not in ["estimate_days","progress"] else 0
            changed = True
    for col in ["project_id","task_id","title","description","assignee","priority","status","labels","start_date","due_date","created_at","updated_at","parent_task_id"]:
        if col in df_t.columns:
            df_t[col] = df_t[col].astype(object).map(_s)
    df_t["progress"] = pd.to_numeric(df_t.get("progress", 0), errors="coerce").fillna(0).clip(0,100).astype(int)
    df_t["estimate_days"] = pd.to_numeric(df_t.get("estimate_days", 0.0), errors="coerce").fillna(0).astype(float)

    # Comments
    for col in ["entity_type","entity_id","author","body","created_at"]:
        if col in df_c.columns:
            df_c[col] = df_c[col].astype(object).map(_s)

    # Contracts
    ct_cols = ["contract_id","project_id","contractor","customer","contract_name","period_start","period_end","contract_amount","contract_status","created_at","updated_at"]
    for c in ct_cols:
        if c not in df_ct.columns:
            df_ct[c] = "" if c != "contract_amount" else 0
            changed = True
    for c in ct_cols:
        if c in df_ct.columns:
            if c == "contract_amount":
                df_ct[c] = pd.to_numeric(df_ct[c], errors="coerce").fillna(0).astype(int)
            else:
                df_ct[c] = df_ct[c].astype(object).map(_s)

    # Billings
    bl_cols = ["bill_id","project_id","item","amount","due_date","request","note","created_at","updated_at"]
    for c in bl_cols:
        if c not in df_bl.columns:
            df_bl[c] = "" if c not in ["bill_id","amount"] else 0
            changed = True
    if not df_bl.empty:
        df_bl["bill_id"] = pd.to_numeric(df_bl.get("bill_id", 0), errors="coerce").fillna(0).astype(int)
        df_bl["amount"]  = pd.to_numeric(df_bl.get("amount", 0), errors="coerce").fillna(0).astype(int)
    for c in ["project_id","item","due_date","request","note","created_at","updated_at"]:
        if c in df_bl.columns:
            df_bl[c] = df_bl[c].astype(object).map(_s)
    df_bl["item"]    = df_bl.get("item","ì¤‘ë„ê¸ˆ").fillna("ì¤‘ë„ê¸ˆ").replace("", "ì¤‘ë„ê¸ˆ")
    df_bl["request"] = df_bl.get("request","N").astype(object).map(_s).map(lambda x: "Y" if str(x).upper()=="Y" else "N")

    # ContractFiles
    cf_cols = ["file_id","project_id","filename","path","note","uploaded_at","file_hash"]
    for c in cf_cols:
        if c not in df_cf.columns:
            df_cf[c] = "" if c != "file_id" else 0
            changed = True
    if not df_cf.empty:
        df_cf["file_id"] = pd.to_numeric(df_cf.get("file_id", 0), errors="coerce").fillna(0).astype(int)
    for c in ["project_id","filename","path","note","uploaded_at","file_hash"]:
        if c in df_cf.columns:
            df_cf[c] = df_cf[c].astype(object).map(_s)

    # HumanResources (HR íƒ­ê³¼ ë™ì¼ ëª…ì¹­ìœ¼ë¡œ ê°•ì œ)
    # ê³¼ê±° ìŠ¤í‚¤ë§ˆ â†’ í˜„ì¬ ìŠ¤í‚¤ë§ˆ ë§¤í•‘
    legacy_to_new = {
        "department_role": "dept_role",
        "position_skill":  "grade_skill",
        "allocation_rate": "ratio",
        "planned_md":      "plan_mm",
        "actual_md":       "real_mm",
        "cost_unit":       "wage",
        "planned_cost":    "plan_cost",
        "actual_cost":     "real_cost",
        "diff_md":         "mm_diff",
        "diff_cost":       "cost_diff",
        "remark":          "note",
    }
    hr_target_cols = [
        "no","project_id","project_name","member_name","dept_role","grade_skill",
        "start_date","end_date","ratio","plan_mm","real_mm","wage",
        "plan_cost","real_cost","role","main_task","mm_diff","cost_diff","note"
    ]
    if df_hr is None or df_hr.empty:
        df_hr = pd.DataFrame(columns=hr_target_cols); changed = True
    else:
        # ì»¬ëŸ¼ ë¦¬ë„¤ì„(ë ˆê±°ì‹œ â†’ í˜„ì¬)
        for old, new in legacy_to_new.items():
            if old in df_hr.columns and new not in df_hr.columns:
                df_hr = df_hr.rename(columns={old: new}); changed = True
        # ëˆ„ë½ ì»¬ëŸ¼ ì±„ìš°ê¸°
        for c in hr_target_cols:
            if c not in df_hr.columns:
                df_hr[c] = "" if c in ["project_id","project_name","member_name","dept_role","grade_skill","role","main_task","note"] else 0
                changed = True
        # íƒ€ì… ë³´ì •
        for c in ["project_id","project_name","member_name","dept_role","grade_skill","role","main_task","note","start_date","end_date"]:
            if c in df_hr.columns: df_hr[c] = df_hr[c].astype(object).map(_s)
        for c in ["no","ratio","plan_mm","real_mm","wage","plan_cost","real_cost","mm_diff","cost_diff"]:
            if c in df_hr.columns: df_hr[c] = pd.to_numeric(df_hr[c], errors="coerce").fillna(0)

    # Timesheets
    # ts_id ì œê±°í•˜ê³ , block_startë¥¼ ë¬¸ìì—´ë¡œ ë³´ê´€í•˜ë˜ í¸ì§‘ ì‹œ to_datetime ì²˜ë¦¬
    if df_ts is None or df_ts.empty:
        df_ts = pd.DataFrame(columns=["project_id","member_name","block_start"] + [f"ww{i}" for i in range(1,53)]); changed = True
    else:
        if "ts_id" in df_ts.columns:
            df_ts = df_ts.drop(columns=["ts_id"]); changed = True
        # í•„ìˆ˜ ì»¬ëŸ¼ ë³´ì •
        for c in ["project_id","member_name","block_start"]:
            if c not in df_ts.columns:
                df_ts[c] = ""; changed = True
            else:
                df_ts[c] = df_ts[c].astype(object).map(_s)
        
        
        for i in range(1,53):
            col = f"ww{i}"
            if col not in df_ts.columns:
                df_ts[col] = 0.0; changed = True
            else:
                df_ts[col] = pd.to_numeric(df_ts[col], errors="coerce").fillna(0.0).astype(float)
            
    return df_p, df_t, df_c, df_ct, df_bl, df_cf, df_hr, df_ts, changed

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ í”„ë¡œì íŠ¸ ëª©ë¡ í‘œì‹œ í…Œì´ë¸” â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _build_project_display_numeric(df: pd.DataFrame) -> pd.DataFrame:
    disp = df.copy()
    disp["start_date"] = pd.to_datetime(disp.get("start_date", pd.NaT), errors="coerce")
    disp["end_date"]   = pd.to_datetime(disp.get("end_date",   pd.NaT), errors="coerce")
    delta = disp["end_date"] - disp["start_date"]
    disp["ì”ì—¬ê¸°ê°„"] = delta.dt.days.fillna(0).astype(int)
    base_order = [
        "project_id","project_code","name","owner","sponsor","status",
        "start_date","end_date","ì”ì—¬ê¸°ê°„","contract_amount"
    ]
    cols = [c for c in base_order if c in disp.columns]
    disp = disp[cols].copy().rename(columns={
        "name": "ì‚¬ì—…ëª…", "owner": "Owner", "sponsor": "Sponsor", "status": "Status",
        "start_date": "Start", "end_date": "End", "contract_amount": "ê³„ì•½ê¸ˆì•¡",
    })
    disp.index = range(1, len(disp) + 1)
    disp.index.name = ""
    return disp

def _calc_collected_by_project(df_bl):
    if df_bl.empty: return {}
    d = df_bl[df_bl["request"].astype(str).str.upper() == "Y"].copy()
    grp = d.groupby(d["project_id"].astype(str))["amount"].sum()
    return grp.to_dict()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì•± ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="PMS (Excel Prototype)", layout="wide")
st.title("ğŸ—‚ï¸ Project Management System â€” Excel Prototype (Excel Storage)")

_ensure_excel_initialized()
df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts = _read_all()

# Timesheets ìµœì†Œ ë³´ì •
if "ts_id" in df_ts.columns:
    df_ts = df_ts.drop(columns=["ts_id"])

df_p, df_t, df_c, df_ct, df_bl, df_cf, df_hr, df_ts, schema_changed = _migrate_schema(df_p, df_t, df_c, df_ct, df_bl, df_cf, df_hr, df_ts)
df_t, t_changed = _normalize_task_ids(df_t)
if schema_changed or t_changed:
    _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)

# Tabs
tab_dashboard, tab_projects, tab_contracts, tab_hr, tab_tasks, tab_board, tab_gantt, tab_comments, tab_import = st.tabs(
    ["ğŸ“Š Dashboard", "ğŸ“ Projects", "ğŸ“‘ Contracts", "ğŸ‘¥ Human Resources", "ğŸ§© Tasks", "ğŸ—‚ï¸ Kanban", "ğŸ“… Gantt (Due)", "ğŸ’¬ Comments", "ğŸ“¥ Import/Export"]
)



# â”€â”€â”€â”€â”€â”€â”€â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_dashboard:
    st.subheader("í”„ë¡œì íŠ¸ í˜„í™© ìš”ì•½")

    total_projects   = len(df_p)
    active_projects  = len(df_p[df_p["status"] == "Active"])
    planned_projects = len(df_p[df_p["status"] == "Planned"])
    total_tasks      = len(df_t)
    status_counts    = df_t["status"].value_counts().reindex(TASK_STATUS_OPTIONS, fill_value=0)

    total_contract = int(df_p["contract_amount"].sum()) if not df_p.empty else 0
    collected_all  = int(df_bl.loc[df_bl["request"].astype(str).str.upper()=="Y","amount"].sum()) if not df_bl.empty else 0
    total_balance_due = max(0, total_contract - collected_all)

    m1, m2, m3, m4, m5, m6 = st.columns(6)
    with m1: st.metric("ì „ì²´ í”„ë¡œì íŠ¸", total_projects)
    with m2: st.metric("ì§„í–‰ì¤‘ì¸ í”„ë¡œì íŠ¸", active_projects)
    with m3: st.metric("ì¤€ë¹„ì¤‘ì¸ í”„ë¡œì íŠ¸", planned_projects)
    with m4: st.metric("ì „ì²´ ì‘ì—… ìˆ˜", total_tasks)
    with m5: st.metric("ê³„ì•½ê¸ˆì•¡ í•©ê³„(â‚©)", f"{total_contract:,}")
    with m6: st.metric("ì”ê¸ˆ í•©ê³„(â‚©)", f"{total_balance_due:,}")

    st.markdown("### ğŸ“‹ í”„ë¡œì íŠ¸ ëª©ë¡ (Active + Planned)")
    dash_df = df_p[df_p["status"].isin(["Active","Planned"])].copy()
    if dash_df.empty:
        st.info("Active ë˜ëŠ” Planned ìƒíƒœì˜ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
    else:
        blY = df_bl[df_bl["request"].astype(str).str.upper() == "Y"].copy() if not df_bl.empty else pd.DataFrame(columns=["project_id","amount"])
        per_proj_collected = blY.groupby(blY["project_id"].astype(str))["amount"].sum().astype(int) if not blY.empty else pd.Series(dtype=int)
        dash_disp = _build_project_display_numeric(dash_df)

        def _proj_balance(pid: str, amt: int) -> int:
            got = int(per_proj_collected.get(str(pid), 0)) if len(per_proj_collected) else 0
            return max(0, int(amt) - got)

        dash_disp["ì”ê¸ˆ"] = [
            _proj_balance(pid, amt)
            for pid, amt in zip(dash_disp["project_id"].astype(str), dash_disp["ê³„ì•½ê¸ˆì•¡"])
        ]
        dash_disp["ê³„ì•½ê¸ˆì•¡(KRW)"] = dash_disp["ê³„ì•½ê¸ˆì•¡"].apply(lambda x: f"{int(x):,}" if pd.notna(x) else "")
        dash_disp["ì”ê¸ˆ(KRW)"]   = dash_disp["ì”ê¸ˆ"].apply(lambda x: f"{int(x):,}" if pd.notna(x) else "")
        dash_cols = ["project_id","project_code","ì‚¬ì—…ëª…","Owner","Sponsor","Status","Start","End","ì”ì—¬ê¸°ê°„","ê³„ì•½ê¸ˆì•¡(KRW)","ì”ê¸ˆ(KRW)"]
        dash_cols = [c for c in dash_cols if c in dash_disp.columns]
        st.dataframe(dash_disp[dash_cols], width='stretch', height=360)

        st.divider()
        st.caption("ì‘ì—… ìƒíƒœ ë¶„í¬")
        chart_df = pd.DataFrame({"Status": status_counts.index, "Count": status_counts.values})
        fig = px.bar(chart_df, x="Status", y="Count", text="Count")
        fig.update_traces(textposition="outside")
        fig.update_layout(margin=dict(l=0, r=0, t=24, b=0))
        st.plotly_chart(fig, config={"displaylogo": False}, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ Projects â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_projects:
    st.subheader("í”„ë¡œì íŠ¸")

    # ë²„íŠ¼ ì¤„
    b1, b2, _sp = st.columns([0.18,0.18,0.64], gap="small")
    with b1:
        if st.button("â• í”„ë¡œì íŠ¸ ì¶”ê°€/ìˆ˜ì •", key=k("proj","open_form_btn")):
            st.session_state[k("proj","show_form")] = True
            st.session_state[k("proj","do_scroll")] = True
            st.rerun()
    with b2:
        if st.button("ğŸ—‘ ì„ íƒ ì‚­ì œ", key=k("proj","bulk_delete_btn")):
            st.session_state[k("proj","trigger_delete")] = True

    st.markdown("### í”„ë¡œì íŠ¸ ëª©ë¡")
    disp = _build_project_display_numeric(df_p)
    disp.insert(0, "ì„ íƒ", False)
    column_order = ["ì„ íƒ","project_id","project_code","ì‚¬ì—…ëª…","Owner","Sponsor","Status","Start","End","ì”ì—¬ê¸°ê°„","ê³„ì•½ê¸ˆì•¡"]
    edited = st.data_editor(
        disp,
        column_order=[c for c in column_order if c in disp.columns],
        column_config={
            "ì„ íƒ": st.column_config.CheckboxColumn("ì„ íƒ", width="small", help="ì‚­ì œí•  í”„ë¡œì íŠ¸ ì„ íƒ"),
            "ê³„ì•½ê¸ˆì•¡": st.column_config.NumberColumn("ê³„ì•½ê¸ˆì•¡"),
            "ì”ì—¬ê¸°ê°„": st.column_config.NumberColumn("ì”ì—¬ê¸°ê°„")
        },
        disabled=[c for c in disp.columns if c != "ì„ íƒ"],
        width='stretch', height=430, hide_index=True,
        key=k("proj","editor","list")
    )
    st.caption("ì¹¼ëŸ¼ í—¤ë” í´ë¦­ìœ¼ë¡œ ì •ë ¬ í† ê¸€ (â–²/â–¼)")

    selected_pids = edited.loc[edited["ì„ íƒ"] == True, "project_id"].astype(str).tolist() if "project_id" in edited.columns else []

    if st.session_state.get(k("proj","trigger_delete"), False):
        st.session_state[k("proj","trigger_delete")] = False
        if not selected_pids:
            st.warning("ì„ íƒëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
        else:
            st.session_state[k("proj","pending_delete_pids")] = selected_pids
            st.session_state[k("proj","show_confirm")] = True
            st.rerun()

    if st.session_state.get(k("proj","show_confirm"), False):
        pending = st.session_state.get(k("proj","pending_delete_pids"), [])
        st.warning(f"ì„ íƒí•œ {len(pending)}ê°œ í”„ë¡œì íŠ¸ì™€ ì—°ê²°ëœ ëª¨ë“  ì‘ì—…/ì½”ë©˜íŠ¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        cA, cB = st.columns([1,1])
        with cA:
            if st.button("âœ… ì˜ˆ, ì‚­ì œí•©ë‹ˆë‹¤", key=k("proj","bulk_delete_yes")):
                pids = [str(x) for x in pending]
                df_p = df_p[~df_p["project_id"].astype(str).isin(pids)]
                del_tasks = df_t[df_t["project_id"].astype(str).isin(pids)]
                df_t = df_t[~df_t["project_id"].astype(str).isin(pids)]
                df_c = df_c[~((df_c["entity_type"].astype(object).map(_s).str.lower()=="project") & (df_c["entity_id"].astype(object).map(_s).isin(pids)))]
                if not del_tasks.empty:
                    tids = del_tasks["task_id"].astype(str).tolist()
                    df_c = df_c[~((df_c["entity_type"].astype(object).map(_s).str.lower()=="task") & (df_c["entity_id"].astype(object).map(_s).isin(tids)))]
                df_ct = df_ct[~df_ct["project_id"].astype(str).isin(pids)]
                df_bl = df_bl[~df_bl["project_id"].astype(str).isin(pids)]
                # íŒŒì¼ ë©”íƒ€/ë””ìŠ¤í¬ë„ í•¨ê»˜ ì •ë¦¬
                del_files = df_cf[df_cf["project_id"].astype(str).isin(pids)]
                for _, r in del_files.iterrows():
                    pth = _s(r.get("path",""))
                    if pth and os.path.isfile(pth):
                        try: os.remove(pth)
                        except: pass
                df_cf = df_cf[~df_cf["project_id"].astype(str).isin(pids)]
                _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                st.session_state[k("proj","pending_delete_pids")] = []
                st.session_state[k("proj","show_confirm")] = False
                st.success("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
                st.rerun()
        with cB:
            if st.button("ì·¨ì†Œ", key=k("proj","bulk_delete_cancel")):
                st.session_state[k("proj","pending_delete_pids")] = []
                st.session_state[k("proj","show_confirm")] = False
                st.info("ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
                st.rerun()

    if k("proj","show_form") not in st.session_state:
        st.session_state[k("proj","show_form")] = False
    if st.session_state.get(k("proj","show_form"), False):
        st.markdown("---")
        st.markdown("<div id='projform'></div>", unsafe_allow_html=True)
        if st.session_state.get(k("proj","do_scroll"), False):
            scroll_to("projform")
            st.session_state[k("proj","do_scroll")] = False

        st.markdown("### í”„ë¡œì íŠ¸ ì¶”ê°€/ìˆ˜ì •")
        if st.button("ë‹«ê¸°", key=k("proj","close_form")):
            st.session_state[k("proj","show_form")] = False
            st.rerun()

        left, right = st.columns(2)
        with left:
            edit_mode = st.toggle("ìˆ˜ì • ëª¨ë“œ", value=False, key=k("proj","edit_mode"))
            selected_project_id = None
            if edit_mode and not df_p.empty:
                selected_project_id = st.selectbox(
                    "ìˆ˜ì •í•  í”„ë¡œì íŠ¸",
                    options=safe_select_options(df_p["project_id"]),
                    format_func=safe_fmt_by(df_p, "project_id", "name"),
                    key=k("proj","select_edit")
                )

        def _project_form_defaults(row=None):
            return {
                "project_id": (_s(row.get("project_id","")) if row is not None else ""),
                "project_code": (_s(row.get("project_code","")) if row is not None else ""),
                "name": (_s(row.get("name","")) if row is not None else ""),
                "owner": (_s(row.get("owner","")) if row is not None else ""),
                "sponsor": (_s(row.get("sponsor","")) if row is not None else ""),
                "status": (_s(row.get("status","Active")) if row is not None else "Active"),
                "start_date": parse_dt(_safe_date_str(row.get("start_date"))) if (row is not None and _safe_date_str(row.get("start_date"))) else date.today(),
                "end_date": parse_dt(_safe_date_str(row.get("end_date"))) if (row is not None and _safe_date_str(row.get("end_date"))) else date.today(),
                "contract_amount": f"{int(pd.to_numeric(row.get('contract_amount',0), errors='coerce') or 0):,}" if row is not None else "",
            }

        # --- ìˆ˜ì • ëª¨ë“œ ---
        if edit_mode and selected_project_id is not None:
            row = df_p[df_p["project_id"].astype(str) == str(selected_project_id)].iloc[0].to_dict()
            d = _project_form_defaults(row)
            with st.form(key=k("proj","edit_form",selected_project_id), clear_on_submit=False):
                colA, colB = st.columns(2)
                with colA:
                    new_pid     = st.text_input("project_id (ë¬¸ì/ìˆ«ì í—ˆìš©, ë³€ê²½ ì‹œ ì—°ê²° ë°ì´í„°ë„ ë³€ê²½)", value=d["project_id"], key=k("proj","id_edit",selected_project_id))
                    project_code= st.text_input("Project Code", value=d["project_code"], key=k("proj","code_edit",selected_project_id))
                    name        = st.text_input("ì‚¬ì—…ëª…", value=d["name"], key=k("proj","name_edit",selected_project_id))
                    owner       = st.text_input("Owner", value=d["owner"], key=k("proj","owner_edit",selected_project_id))
                    sponsor     = st.text_input("Sponsor", value=d["sponsor"], key=k("proj","sponsor_edit",selected_project_id))
                with colB:
                    status      = st.selectbox("Status", options=PROJECT_STATUS_OPTIONS,
                                               index=PROJECT_STATUS_OPTIONS.index(d["status"]) if d["status"] in PROJECT_STATUS_OPTIONS else 1,
                                               key=k("proj","status_edit",selected_project_id))
                    start_date  = st.date_input("Start", value=d["start_date"].date() if isinstance(d["start_date"], datetime) else d["start_date"], key=k("proj","start_edit",selected_project_id))
                    end_date    = st.date_input("End",   value=d["end_date"].date()   if isinstance(d["end_date"],   datetime) else d["end_date"],   key=k("proj","end_edit",selected_project_id))
                    amt_in      = st.text_input("ê³„ì•½ê¸ˆì•¡ (KRW, ìˆ«ìë§Œ)", value=d["contract_amount"], placeholder="ì˜ˆ: 150000000", key=k("proj","amt_edit",selected_project_id))
                submitted = st.form_submit_button("ì €ì¥(ìˆ˜ì •)")

                # ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬: End >= Start
                if submitted:
                    if end_date < start_date:
                        st.error("âš ï¸ ì¢…ë£Œì¼(End)ì€ ì‹œì‘ì¼(Start)ë³´ë‹¤ ì´ì „ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                        st.stop()
                    new_pid = _s(new_pid)
                    if new_pid == "":
                        st.error("project_idëŠ” ë¹„ìš¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); st.stop()
                    amt_val = _parse_int_from_krw_strict(amt_in)
                    old_pid = _s(selected_project_id)
                    pid_changed = (new_pid != old_pid)
                    if pid_changed and new_pid in df_p["project_id"].astype(str).tolist():
                        st.error(f"ì´ë¯¸ ì¡´ì¬í•˜ëŠ” project_id ì…ë‹ˆë‹¤: {new_pid}"); st.stop()
                    if pid_changed:
                        df_p.loc[df_p["project_id"].astype(str) == old_pid, "project_id"] = new_pid
                        df_t.loc[df_t["project_id"].astype(str) == old_pid, "project_id"] = new_pid
                        df_c.loc[(df_c["entity_type"].astype(object).map(_s).str.lower()=="project") & (df_c["entity_id"].astype(object).map(_s)==old_pid), "entity_id"] = new_pid
                        df_ct.loc[df_ct["project_id"].astype(str) == old_pid, "project_id"] = new_pid
                        df_bl.loc[df_bl["project_id"].astype(str) == old_pid, "project_id"] = new_pid
                        df_cf.loc[df_cf["project_id"].astype(str) == old_pid, "project_id"] = new_pid
                    df_p.loc[df_p["project_id"].astype(str) == (new_pid if pid_changed else old_pid),
                             ["project_code","name","owner","sponsor","status","start_date","end_date","contract_amount","updated_at"]] = [
                        project_code, name, owner, sponsor, status, _safe_date_str(start_date), _safe_date_str(end_date), int(amt_val), _now_iso()
                    ]
                    _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                    st.success(f"í”„ë¡œì íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. (ID: {new_pid})")
                    st.rerun()
        # --- ì‹ ê·œ ëª¨ë“œ ---
        else:
            with st.form(key=k("proj","new_form"), clear_on_submit=True):
                colA, colB = st.columns(2)
                with colA:
                    project_id_in = st.text_input("project_id (ë¬¸ì/ìˆ«ì í—ˆìš©, ë¯¸ì…ë ¥ ì‹œ ìë™ ë²ˆí˜¸)", value="", key=k("proj","id_new"))
                    project_code  = st.text_input("Project Code", value="", key=k("proj","code_new"))
                    name          = st.text_input("ì‚¬ì—…ëª…", value="", key=k("proj","name_new"))
                    owner         = st.text_input("Owner", value="", key=k("proj","owner_new"))
                    sponsor       = st.text_input("Sponsor", value="", key=k("proj","sponsor_new"))
                with colB:
                    status        = st.selectbox("Status", options=PROJECT_STATUS_OPTIONS, index=1, key=k("proj","status_new"))
                    start_date    = st.date_input("Start", value=date.today(), key=k("proj","start_new"))
                    end_date      = st.date_input("End",   value=date.today(), key=k("proj","end_new"))
                    amt_in        = st.text_input("ê³„ì•½ê¸ˆì•¡ (KRW, ìˆ«ìë§Œ)", value="", placeholder="ì˜ˆ: 150000000", key=k("proj","amt_new"))
                submitted = st.form_submit_button("ì¶”ê°€(ì‹ ê·œ)")

                # ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬: End >= Start
                if submitted:
                    if end_date < start_date:
                        st.error("âš ï¸ ì¢…ë£Œì¼(End)ì€ ì‹œì‘ì¼(Start)ë³´ë‹¤ ì´ì „ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); st.stop()
                    if not name.strip():
                        st.error("ì‚¬ì—…ëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); st.stop()
                    amt_val = _parse_int_from_krw_strict(amt_in)
                    if _s(project_id_in) == "":
                        new_num, df_m = _next_id(df_m, "project_id_seq")
                        new_id = str(new_num)
                    else:
                        new_id = _s(project_id_in)
                        if new_id in df_p["project_id"].astype(str).tolist():
                            st.error(f"ì´ë¯¸ ì¡´ì¬í•˜ëŠ” project_id ì…ë‹ˆë‹¤: {new_id}"); st.stop()
                    df_p.loc[len(df_p)] = {
                        "project_id": new_id, "project_code": project_code, "name": name,
                        "owner": owner, "sponsor": sponsor, "status": status,
                        "contract_amount": int(amt_val),
                        "start_date": _safe_date_str(start_date), "end_date": _safe_date_str(end_date),
                        "created_at": _now_iso(), "updated_at": _now_iso()
                    }
                    _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                    st.success(f"í”„ë¡œì íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ID: {new_id}")
                    st.rerun()

# ====== [BEGIN] Contracts Tab ======
def ck(*parts):  # contract-scoped session keys
    return k("contract", *parts)

def _hash_bytes_contract(b: bytes) -> str:
    h = hashlib.sha1(); h.update(b); return h.hexdigest()

def _all_bill_Y(pid: str) -> bool:
    if df_bl.empty: return False
    d = df_bl[df_bl["project_id"].astype(str) == str(pid)]
    if d.empty: return False
    return (d["request"].astype(str).str.upper() == "Y").all()

def _proj_created_yymmdd(pid: str) -> str:
    row = df_p[df_p["project_id"].astype(str) == str(pid)]
    if row.empty: return datetime.now().strftime("%y%m%d")
    created = _s(row.iloc[0].get("created_at",""))
    if created:
        try: return parse_dt(created).strftime("%y%m%d")
        except Exception: pass
    sdate = _s(row.iloc[0].get("start_date",""))
    if sdate:
        try: return parse_dt(sdate).strftime("%y%m%d")
        except Exception: pass
    return datetime.now().strftime("%y%m%d")

def _gen_contract_id(pid: str, df_ct: pd.DataFrame) -> str:
    base = _proj_created_yymmdd(pid)
    existed = df_ct[df_ct["project_id"].astype(str) == str(pid)]
    cnt = 0
    if "contract_id" in existed.columns:
        for v in existed["contract_id"].astype(str):
            if isinstance(v, str) and v.startswith(f"AICESS-{base}"):
                cnt += 1
    return f"AICESS-{base}{cnt+1:02d}"

with tab_contracts:
    st.subheader("ê³„ì•½ê´€ë¦¬")

    if df_p.empty:
        st.info("ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.")
    else:
        # í”„ë¡œì íŠ¸ ì„ íƒ (ì‚¬ì—…ëª… í¬ë§·)
        proj_id = st.selectbox(
            "í”„ë¡œì íŠ¸ ì„ íƒ",
            options=safe_select_options(df_p["project_id"]),
            format_func=safe_fmt_by(df_p, "project_id", "name"),
            key=ck("proj_select")
        )

        # ê³„ì•½ í—¤ë” í™•ë³´ + contract_id ë³´ì •
        if "contract_id" not in df_ct.columns:
            df_ct["contract_id"] = ""
        sel = df_ct[df_ct["project_id"].astype(str) == proj_id].copy()
        if sel.empty:
            df_ct.loc[len(df_ct)] = {
                "project_id": proj_id,
                "contractor": "",
                "customer": "",
                "contract_name": f"{safe_fmt_by(df_p,'project_id','name')(proj_id)} ê³„ì•½",
                "period_start": _safe_date_str(df_p.loc[df_p["project_id"].astype(str)==proj_id,"start_date"].values[0] if not df_p.empty else date.today()),
                "period_end":   _safe_date_str(df_p.loc[df_p["project_id"].astype(str)==proj_id,"end_date"].values[0] if not df_p.empty else date.today()),
                "contract_amount": int(df_p.loc[df_p["project_id"].astype(str)==proj_id,"contract_amount"].values[0]) if not df_p.empty else 0,
                "contract_status": "ì‘ì„±ì¤‘",
                "created_at": _now_iso(), "updated_at": _now_iso(),
                "contract_id": ""
            }
            _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
            sel = df_ct[df_ct["project_id"].astype(str) == proj_id].copy()

        if _s(sel.iloc[0].get("contract_id","")) == "":
            new_cid = _gen_contract_id(proj_id, df_ct)
            df_ct.loc[df_ct["project_id"].astype(str)==proj_id,"contract_id"] = new_cid
            _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
            sel = df_ct[df_ct["project_id"].astype(str) == proj_id].copy()

        row = sel.iloc[0].to_dict()
        proj_amount = int(df_p.loc[df_p["project_id"].astype(str)==proj_id,"contract_amount"].values[0]) if not df_p.empty else 0

        # â”€â”€ ê³„ì•½ì •ë³´
        st.markdown("### ê³„ì•½ì •ë³´")
        with st.form(key=ck("header_form", proj_id), clear_on_submit=False):
            c1, c2 = st.columns(2)
            with c1:
                st.text_input("ê³„ì•½ ID", value=_s(row.get("contract_id","")), disabled=True, key=ck("cid",proj_id))
                contractor = st.text_input("ê³„ì•½ì—…ì²´", value=_s(row.get("contractor","")), key=ck("contractor",proj_id))
                customer   = st.text_input("ë°œì£¼ì‚¬",   value=_s(row.get("customer","")),   key=ck("customer",proj_id))
                cname      = st.text_input("ê³„ì•½ëª…",   value=_s(row.get("contract_name","")), key=ck("cname",proj_id))
            with c2:
                pstart = st.date_input("ê³„ì•½ ì‹œì‘",
                    value=(parse_dt(row["period_start"]).date() if _s(row.get("period_start","")) else date.today()),
                    key=ck("pstart",proj_id))
                pend   = st.date_input("ê³„ì•½ ì¢…ë£Œ",
                    value=(parse_dt(row["period_end"]).date() if _s(row.get("period_end","")) else date.today()),
                    key=ck("pend",proj_id))
                status = st.selectbox("ê³„ì•½ ìƒíƒœ", options=CONTRACT_STATUS_OPTIONS,
                    index=(CONTRACT_STATUS_OPTIONS.index(_s(row.get("contract_status","ì‘ì„±ì¤‘"))) if _s(row.get("contract_status","ì‘ì„±ì¤‘")) in CONTRACT_STATUS_OPTIONS else 0),
                    key=ck("status",proj_id))

            # ë‚ ì§œ ìœ íš¨ì„±: ì¢…ë£Œ >= ì‹œì‘
            if pend < pstart:
                st.error("âš ï¸ ê³„ì•½ ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ë³´ë‹¤ ì´ì „ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì €ì¥ ë¶ˆê°€.")

            st.info(f"ê³„ì•½ê¸ˆì•¡(í”„ë¡œì íŠ¸ì—ì„œ ê´€ë¦¬): **{proj_amount:,} KRW**")
            if status == "ë³€ê²½":
                try: header_amt = int(sel["contract_amount"].values[0])
                except Exception: header_amt = proj_amount
                if header_amt != proj_amount:
                    st.warning("ê³„ì•½ìƒíƒœê°€ ë³€ê²½ì…ë‹ˆë‹¤. í˜„ì¬ ê³„ì•½ì •ë³´ ê¸ˆì•¡ê³¼ í”„ë¡œì íŠ¸ ê¸ˆì•¡ì´ ë‹¤ë¦…ë‹ˆë‹¤.\n\ní”„ë¡œì íŠ¸ íƒ­ì—ì„œ ê³„ì•½ê¸ˆì•¡ì„ ìˆ˜ì •í•˜ì„¸ìš”.")
            submit_header = st.form_submit_button("ê¸°ë³¸ì •ë³´ ìˆ˜ì •")

        if submit_header:
            if pend < pstart:
                st.error("ê³„ì•½ ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ë¹ ë¦…ë‹ˆë‹¤. ìˆ˜ì • í›„ ì €ì¥í•˜ì„¸ìš”.")
            else:
                _status = st.session_state[ck("status",proj_id)]
                if _status == "ì¢…ë£Œ" and not _all_bill_Y(proj_id):
                    st.error("ìˆ˜ê¸ˆê³„íš/ì‹¤í–‰ì„ ëª¨ë‘ ì™„ë£Œ(Y)ë¡œ ë³€ê²½í•œ ë’¤ ì¢…ë£Œë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
                else:
                    df_ct.loc[df_ct["project_id"].astype(str)==proj_id,
                              ["customer","contract_name","period_start","period_end","updated_at","contract_status","contractor"]] = [
                        st.session_state[ck("customer",proj_id)],
                        st.session_state[ck("cname",proj_id)],
                        _safe_date_str(st.session_state[ck("pstart",proj_id)]),
                        _safe_date_str(st.session_state[ck("pend",proj_id)]),
                        _now_iso(),
                        _status,
                        st.session_state[ck("contractor",proj_id)],
                    ]
                    _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                    st.success("ê³„ì•½ ê¸°ë³¸ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

        # â”€â”€ ìˆ˜ê¸ˆê³„íš/ì‹¤í–‰
        st.markdown("---")
        st.markdown("### ìˆ˜ê¸ˆê³„íš/ì‹¤í–‰")
        bills = df_bl[df_bl["project_id"].astype(str)==proj_id].copy()
        if bills.empty:
            bills = pd.DataFrame(columns=["bill_id","project_id","item","amount","due_date","request","note","created_at","updated_at"])
        bills["amount"] = pd.to_numeric(bills.get("amount", 0), errors="coerce").fillna(0).astype(int)
        bills["item"]   = bills.get("item","ì¤‘ë„ê¸ˆ").fillna("ì¤‘ë„ê¸ˆ").replace("","ì¤‘ë„ê¸ˆ").astype(str)
        bills["request"]= bills.get("request","N").fillna("N").map(lambda x: "Y" if _s(x).upper()=="Y" else "N").astype(str)
        bills["note"]   = bills.get("note","").fillna("").astype(str)
        bills["due_date"] = pd.to_datetime(bills.get("due_date", None), errors="coerce").dt.date

        bills_disp = bills[["item","amount","due_date","request","note"]].copy() if not bills.empty \
                     else pd.DataFrame(columns=["item","amount","due_date","request","note"]).copy()

        if st.button("ï¼‹ í•­ëª© ì¶”ê°€", key=ck("add_row",proj_id)):
            bills_disp.loc[len(bills_disp)] = {"item":"ì¤‘ë„ê¸ˆ","amount":0,"due_date":date.today(),"request":"N","note":""}

        edited_bills = st.data_editor(
            bills_disp.reset_index(drop=True),
            width='stretch', height=340, num_rows="dynamic",
            column_config={
                "item":     st.column_config.SelectboxColumn("í•­ëª©", options=BILL_ITEM_OPTIONS, required=True),
                "amount":   st.column_config.NumberColumn("ìˆ˜ê¸ˆ ê¸ˆì•¡(KRW)", min_value=0, step=1),
                "due_date": st.column_config.DateColumn("ìˆ˜ê¸ˆ ì˜ˆì •ì¼"),
                "request":  st.column_config.SelectboxColumn("ìˆ˜ê¸ˆ ìš”ì²­ ì—¬ë¶€", options=YN_OPTIONS),
                "note":     st.column_config.TextColumn("ë¹„ê³ "),
            },
            key=ck("editor",proj_id),
        )

        if st.button("ğŸ’¾ ìˆ˜ê¸ˆê³„íš/ì‹¤í–‰ ì €ì¥", key=ck("save_bills",proj_id)):
            df_bl = df_bl[df_bl["project_id"].astype(str) != proj_id]
            for _, r in edited_bills.iterrows():
                item = (_s(r.get("item","")) or "ì¤‘ë„ê¸ˆ")
                amt  = int(_parse_int_from_krw_strict(r.get("amount", 0)))
                due_raw = r.get("due_date","")
                # ë‚ ì§œëŠ” None í—ˆìš©(ë¹„ì›Œë‘˜ ìˆ˜ ìˆìŒ)
                if isinstance(due_raw, (datetime, date)):
                    due = _safe_date_str(due_raw)
                else:
                    try: due = _safe_date_str(parse_dt(str(due_raw)).date())
                    except Exception: due = ""
                req  = "Y" if _s(r.get("request","N")).upper()=="Y" else "N"
                note = _s(r.get("note",""))
                new_id, df_m = _next_id(df_m, "bill_id_seq")
                df_bl.loc[len(df_bl)] = {
                    "bill_id": int(new_id),"project_id": proj_id,"item": item,"amount": int(amt),
                    "due_date": due,"request": req,"note": note,
                    "created_at": _now_iso(),"updated_at": _now_iso()
                }
            _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
            st.success("ìˆ˜ê¸ˆê³„íš/ì‹¤í–‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

        collected = int(df_bl[(df_bl["project_id"].astype(str)==proj_id) &
                              (df_bl["request"].astype(str).str.upper()=="Y")]["amount"].sum())
        balance   = max(int(proj_amount) - collected, 0)
        st.info(f"ì”ê¸ˆ: **{balance:,} KRW**  (= ê³„ì•½ê¸ˆì•¡ {proj_amount:,} - ìˆ˜ê¸ˆìš”ì²­(Y) í•© {collected:,})")

        # â”€â”€ ê³„ì•½ì„œ ì—…ë¡œë“œ/ê´€ë¦¬: ë””ìŠ¤í¬ ì €ì¥ + Excel ë©”íƒ€ + ì„ íƒ ZIP ë‹¤ìš´ë¡œë“œ/ì‚­ì œ
        st.markdown("---")
        st.markdown("### ê³„ì•½ì„œ ì—…ë¡œë“œ/ê´€ë¦¬")
        os.makedirs(os.path.join(UPLOAD_ROOT, str(proj_id)), exist_ok=True)

        up_files = st.file_uploader(
            "ê³„ì•½ì„œ ì—…ë¡œë“œ (hwp, hwpx, xlsx, docx, pdf)",
            type=["hwp","hwpx","xlsx","docx","pdf"],
            accept_multiple_files=True,
            key=ck("uploader",proj_id)
        )
        # ì—…ë¡œë“œ ì²˜ë¦¬
        sig = _files_signature(up_files) if up_files else None
        if sig and st.session_state.get(ck("last_sig")) != sig:
            added = dup = 0
            for f in up_files:
                content = f.getbuffer()
                h = _hash_bytes_contract(bytes(content))
                # ì¤‘ë³µ ì²´í¬: ê°™ì€ í”„ë¡œì íŠ¸, ë™ì¼ í•´ì‹œ ë˜ëŠ” ë™ì¼ íŒŒì¼ëª…
                dup_mask = (df_cf["project_id"].astype(str)==str(proj_id)) & (
                    (df_cf["file_hash"]==h) | (df_cf["filename"]==_s(f.name))
                )
                if dup_mask.any():
                    dup += 1
                    continue
                # ë””ìŠ¤í¬ ì €ì¥
                safe_name = _s(f.name)
                save_path = os.path.join(UPLOAD_ROOT, str(proj_id), safe_name)
                with open(save_path, "wb") as out:
                    out.write(content)

                # ë©”íƒ€ ê¸°ë¡
                new_id, df_m = _next_id(df_m, "file_id_seq")
                df_cf.loc[len(df_cf)] = {
                    "file_id": int(new_id),
                    "project_id": str(proj_id),
                    "filename": safe_name,
                    "path": save_path,
                    "note": "",
                    "uploaded_at": _now_iso(),
                    "file_hash": h
                }
                added += 1
            st.session_state[ck("last_sig")] = sig
            if added or dup:
                _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                st.success(f"ì—…ë¡œë“œ ì²˜ë¦¬: ì¶”ê°€ {added} / ì¤‘ë³µ {dup}")
                st.rerun()

        # í˜„ì¬ íŒŒì¼ ëª©ë¡ í‘œì‹œ
        cur_files = df_cf[df_cf["project_id"].astype(str)==str(proj_id)].copy()
        cur_files = cur_files.sort_values("uploaded_at", ascending=False).reset_index(drop=True)
        view = cur_files[["filename","uploaded_at","note"]].copy()
        view["note"] = view["note"].fillna("").astype(str)
        view.insert(0, "ë²ˆí˜¸", range(1, len(view)+1))
        view.insert(0, "ì„ íƒ", False)

        edited_view = st.data_editor(
            view,
            width='stretch', height=300, num_rows="fixed", hide_index=True,
            column_config={
                "ì„ íƒ": st.column_config.CheckboxColumn("ì„ íƒ", width="small", help="ë‹¤ìš´ë¡œë“œ/ì‚­ì œí•  íŒŒì¼ ì„ íƒ"),
                "ë²ˆí˜¸":  st.column_config.Column("ë²ˆí˜¸", width="small", disabled=True),
                "filename": st.column_config.TextColumn("íŒŒì¼ëª…", disabled=True),
                "uploaded_at": st.column_config.TextColumn("ë“±ë¡ì¼ì", disabled=True),
                "note": st.column_config.TextColumn("ë¹„ê³ "),
            },
            key=ck("files_table",proj_id)
        )

        # ë¹„ê³  ì €ì¥
        if st.button("ë¹„ê³  ì €ì¥", key=ck("save_notes",proj_id)):
            for _, rv in edited_view.iterrows():
                fn = _s(rv["filename"]); nt = _s(rv.get("note",""))
                df_cf.loc[(df_cf["project_id"].astype(str)==str(proj_id)) & (df_cf["filename"]==fn), "note"] = nt
            _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
            st.success("ë¹„ê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

        sel_mask = edited_view["ì„ íƒ"] == True if "ì„ íƒ" in edited_view.columns else pd.Series([], dtype=bool)
        sel_names = edited_view.loc[sel_mask, "filename"].astype(str).tolist()

        cdl, cdel = st.columns(2)
        with cdl:
            # ì„ íƒ ZIP ë‹¤ìš´ë¡œë“œ
            if st.button("â¬‡ ì„ íƒ íŒŒì¼ ZIP ë‹¤ìš´ë¡œë“œ", key=ck("zip_dl_btn",proj_id)):
                if not sel_names:
                    st.warning("ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
                else:
                    # ì„ íƒëœ íŒŒì¼ ê²½ë¡œ ìˆ˜ì§‘
                    paths = df_cf[(df_cf["project_id"].astype(str)==str(proj_id)) & (df_cf["filename"].astype(str).isin(sel_names))]["path"].astype(str).tolist()
                    if not paths:
                        st.warning("ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                    else:
                        mem = io.BytesIO()
                        with zipfile.ZipFile(mem, "w", zipfile.ZIP_DEFLATED) as zf:
                            for p in paths:
                                if os.path.isfile(p):
                                    zf.write(p, arcname=os.path.basename(p))
                        mem.seek(0)
                        st.download_button(
                            label=f"ZIP ë‹¤ìš´ë¡œë“œ ({len(paths)}ê°œ)",
                            data=mem,
                            file_name=f"{proj_id}_contracts_{datetime.now().strftime('%Y%m%d_%H%M%S')}.zip",
                            mime="application/zip",
                            key=ck("zip_download",proj_id)
                        )
        with cdel:
            # ì„ íƒ íŒŒì¼ ì‚­ì œ
            if st.button("ğŸ—‘ ì„ íƒ íŒŒì¼ ì‚­ì œ", key=ck("delete_btn",proj_id)):
                if not sel_names:
                    st.warning("ì„ íƒëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
                else:
                    st.session_state[ck("ask_del",proj_id)] = True

        if st.session_state.get(ck("ask_del",proj_id), False):
            st.warning(f"ì„ íƒëœ {len(sel_names)}ê°œ íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
            cA, cB = st.columns(2)
            with cA:
                if st.button("âœ… ì˜ˆ, ì‚­ì œ", key=ck("do_del",proj_id)):
                    # ë©”íƒ€/ë””ìŠ¤í¬ ë™ì‹œì— ì‚­ì œ
                    rows = df_cf[(df_cf["project_id"].astype(str)==str(proj_id)) &
                                 (df_cf["filename"].astype(str).isin(sel_names))]
                    for _, r in rows.iterrows():
                        pth = _s(r.get("path",""))
                        if pth and os.path.isfile(pth):
                            try: os.remove(pth)
                            except: pass
                    df_cf = df_cf[~((df_cf["project_id"].astype(str)==str(proj_id)) &
                                    (df_cf["filename"].astype(str).isin(sel_names)))]
                    _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                    st.session_state[ck("ask_del",proj_id)] = False
                    st.success("ì‚­ì œ ì™„ë£Œ")
                    st.rerun()
            with cB:
                if st.button("ì·¨ì†Œ", key=ck("cancel_del",proj_id)):
                    st.session_state[ck("ask_del",proj_id)] = False
                    st.info("ì‚­ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.")

# ====== [END] Contracts Tab ======
























# â”€â”€â”€â”€â”€â”€â”€â”€â”€ HR (Human Resources) â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_hr:
    st.subheader("ì¸ë ¥ê´€ë¦¬ & íƒ€ì„ì‹œíŠ¸")

    # í”„ë¡œì íŠ¸ ì„ íƒ
    if df_p.empty:
        st.info("ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.")
        st.stop()
    proj_id = st.selectbox(
        "í”„ë¡œì íŠ¸ ì„ íƒ",
        options=safe_select_options(df_p["project_id"]),
        format_func=safe_fmt_by(df_p, "project_id", "name"),
        key=k("hr","proj_select")
    )

    # í”„ë¡œì íŠ¸ ê¸°ê°„(í”„ë¡œì íŠ¸ íƒ­ ì €ì¥ê°’ ê¸°ì¤€)
    prow = df_p[df_p["project_id"].astype(str)==str(proj_id)]
    proj_start_p = _parse_date_maybe(prow.iloc[0].get("start_date","")) if not prow.empty else date.today()
    proj_end_p   = _parse_date_maybe(prow.iloc[0].get("end_date",""))   if not prow.empty else proj_start_p
    proj_start_p = proj_start_p or date.today()
    proj_end_p   = proj_end_p or proj_start_p

    # ê³„íšê³µìˆ˜ ìë™ê³„ì‚° (ì—…ë¬´ì¼/20 * íˆ¬ì…ë¥ )
    def _calc_plan_mm(start_d, end_d, ratio_pct) -> float:
        sd = _parse_date_maybe(start_d)
        ed = _parse_date_maybe(end_d)
        r  = float(pd.to_numeric(ratio_pct, errors="coerce") or 0.0)
        if not sd or not ed or ed < sd:
            return 0.0
        bdays = business_days_inclusive(sd, ed)  # í† /ì¼ ì œì™¸, ì–‘ë í¬í•¨
        mm = (bdays / 20.0) * (r / 100.0)
        return round(mm, 2)

    # ============ ì¸ë ¥ê´€ë¦¬ í‘œ ============
    st.markdown("### ì¸ë ¥íˆ¬ì… ê³„íš/ì‹¤í–‰")

    base_cols = [
        "no","project_id","project_name","member_name","dept_role","grade_skill",
        "start_date","end_date","ratio","plan_mm","real_mm","wage",
        "plan_cost","real_cost","role","main_task","mm_diff","cost_diff","note"
    ]
    if df_hr.empty:
        df_hr = pd.DataFrame(columns=base_cols)

    hr_rows = df_hr[df_hr["project_id"].astype(str)==str(proj_id)].copy()
    if "no" in hr_rows.columns:
        hr_rows["no"] = pd.to_numeric(hr_rows["no"], errors="coerce").fillna(0).astype(int)
        hr_rows = hr_rows.sort_values("no")

    disp = hr_rows.reindex(columns=base_cols).copy()
    disp["project_id"] = proj_id
    disp["project_name"] = safe_fmt_by(df_p, "project_id", "name")(proj_id)

    # dtype ë³´ì •
    for c in ["start_date","end_date"]:
        disp[c] = pd.to_datetime(disp[c], errors="coerce")
    for c in ["ratio","plan_mm","real_mm","wage","plan_cost","real_cost","mm_diff","cost_diff"]:
        disp[c] = pd.to_numeric(disp[c], errors="coerce")
    for c in ["project_id","project_name","member_name","dept_role","grade_skill","role","main_task","note"]:
        disp[c] = disp[c].astype(object).map(_s)

    # ì„ íƒ ì²´í¬ë°•ìŠ¤
    grid_df = disp.copy()
    grid_df.insert(0, "ì„ íƒ", False)

    colcfg = {
        "no": st.column_config.NumberColumn("no", step=1),
        "project_id": st.column_config.TextColumn("project_id", disabled=True),
        "project_name": st.column_config.TextColumn("í”„ë¡œì íŠ¸ëª…", disabled=True),
        "member_name": st.column_config.TextColumn("ì¸ë ¥ëª…"),
        "dept_role": st.column_config.TextColumn("ì†Œì†/ì§ë¬´", width="small"),
        "grade_skill": st.column_config.TextColumn("ì§ê¸‰/ìŠ¤í‚¬", width="small"),
        "start_date": st.column_config.DateColumn("íˆ¬ì…ì‹œì‘ì¼"),
        "end_date":   st.column_config.DateColumn("íˆ¬ì…ì¢…ë£Œì¼"),
        "ratio":      st.column_config.NumberColumn("íˆ¬ì…ë¥ (%)", min_value=0, max_value=100, step=1),
        "plan_mm":    st.column_config.NumberColumn("ê³„íšê³µìˆ˜(MM)", step=0.01, disabled=True),
        "real_mm":    st.column_config.NumberColumn("ì‹¤ì œ íˆ¬ì…ê³µìˆ˜(MM)", step=0.01, disabled=True),
        "wage":       st.column_config.NumberColumn("ì¸ê±´ë¹„(KRW)", step=1, min_value=0),
        "plan_cost":  st.column_config.NumberColumn("ê³„íšì¸ê±´ë¹„(=ì¸ê±´ë¹„*ê³„íšê³µìˆ˜)", step=1, disabled=True),
        "real_cost":  st.column_config.NumberColumn("ì‹¤ì œì¸ê±´ë¹„(=ì¸ê±´ë¹„*ì‹¤ì œê³µìˆ˜)", step=1, disabled=True),
        "role":       st.column_config.SelectboxColumn("ì—­í• ", options=["PM","PL","ê°œë°œ","ê¸°íš","QA"]),
        "main_task":  st.column_config.TextColumn("ì£¼ìš”ì—…ë¬´", width="medium"),
        "mm_diff":    st.column_config.NumberColumn("ê³„íšëŒ€ë¹„ ê³µìˆ˜(=ê³„íš-ì‹¤ì œ)", step=0.01, disabled=True),
        "cost_diff":  st.column_config.NumberColumn("ê³„íš ëŒ€ë¹„ ë¹„ìš©(=ê³„íš-ì‹¤ì œ)", step=1, disabled=True),
        "note":       st.column_config.TextColumn("ë¹„ê³ ", width="large"),
    }

    # ìƒë‹¨: ì¶”ê°€ ë²„íŠ¼
    topL, _ = st.columns([0.25,0.75])
    with topL:
        if st.button("â• íˆ¬ì…ì¸ë ¥ ì¶”ê°€", key=k("hr","add")):
            next_no = 1 if hr_rows.empty else int(pd.to_numeric(hr_rows["no"], errors="coerce").fillna(0).max()) + 1
            new = {c:"" for c in base_cols}
            new.update({
                "no": next_no, "project_id": proj_id,
                "project_name": safe_fmt_by(df_p,"project_id","name")(proj_id),
                "ratio": 0, "plan_mm": 0.0, "real_mm": 0.0, "wage": 0,
                "plan_cost": 0, "real_cost": 0, "mm_diff": 0.0, "cost_diff": 0
            })
            df_hr.loc[len(df_hr)] = new
            df_ts = _ensure_timesheet_blocks(
                df_ts, str(proj_id), _s(new["member_name"]), proj_start_p, proj_end_p
            )

            _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
            st.rerun()

    # í‘œ í¸ì§‘
    edited = st.data_editor(
        grid_df,
        column_config=colcfg,
        disabled=["project_id","project_name","plan_mm","real_mm","plan_cost","real_cost","mm_diff","cost_diff"],
        width='stretch', height=380, hide_index=True,
        key=k("hr","editor",proj_id)
    )

    # í•©ê³„
    def _sumcol(df: pd.DataFrame, col: str) -> float:
        return float(pd.to_numeric(df.get(col, 0), errors="coerce").fillna(0).sum())
    totals = {
        "plan_mm":  _sumcol(disp, "plan_mm"),
        "real_mm":  _sumcol(disp, "real_mm"),
        "plan_cost": _sumcol(disp, "plan_cost"),
        "real_cost": _sumcol(disp, "real_cost"),
        "mm_diff":   _sumcol(disp, "mm_diff"),
        "cost_diff": _sumcol(disp, "cost_diff"),
    }
    c1,c2,c3,c4,c5,c6 = st.columns(6)
    c1.metric("ê³„íšê³µìˆ˜(MM)", f"{totals['plan_mm']:.2f}")
    c2.metric("ì‹¤ì œê³µìˆ˜(MM)", f"{totals['real_mm']:.2f}")
    c3.metric("ê³„íšë¹„ìš©", f"{int(totals['plan_cost']):,}")
    c4.metric("ì‹¤ì œë¹„ìš©", f"{int(totals['real_cost']):,}")
    c5.metric("ê³µìˆ˜ì°¨ì´", f"{totals['mm_diff']:.2f}")
    c6.metric("ë¹„ìš©ì°¨ì´", f"{int(totals['cost_diff']):,}")

    # í•˜ë‹¨ ë²„íŠ¼: ì‚­ì œ/ì €ì¥/ì„ íƒìˆ˜ì •
    btnA, btnB, btnC, _ = st.columns([0.2,0.2,0.2,0.4])





    with btnA:
        if st.button("ğŸ—‘ ì„ íƒ ì‚­ì œ", key=k("hr","delete")):
            sel_idx = edited.index[edited["ì„ íƒ"]==True].tolist()
            if not sel_idx:
                st.warning("ì„ íƒëœ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.")
            else:
                # 1) ì„ íƒëœ ì¸ë ¥ëª… í™•ë³´ (ìºìŠ¤ì¼€ì´ë“œ ì‚­ì œì— í•„ìš”)
                selected_rows = hr_rows.iloc[sel_idx].copy()
                member_names_to_delete = selected_rows.get("member_name", pd.Series([], dtype=str)).astype(str).map(_s).tolist()

                # 2) HRì—ì„œ ì‚­ì œ
                to_drop = selected_rows.index.tolist()
                df_hr = df_hr.drop(index=to_drop)

                # 3) (ì¤‘ìš”) íƒ€ì„ì‹œíŠ¸ì—ì„œ í•´ë‹¹ ì¸ë ¥ ì „ë¶€ ì‚­ì œ (ìºìŠ¤ì¼€ì´ë“œ)
                #    í•¨ìˆ˜ ì‚¬ìš© ë²„ì „:
                df_ts = _cascade_delete_timesheets(df_ts, str(proj_id), member_names_to_delete)
                #    í•¨ìˆ˜ ì—†ì´ í•œ ì¤„ë¡œ í•  ê±°ë©´:
                # pid = str(proj_id)
                # nm_set = set(_s(n) for n in member_names_to_delete if _s(n))
                # df_ts = df_ts[~((df_ts["project_id"].astype(str)==pid) & (df_ts["member_name"].astype(str).map(_s).isin(nm_set)))].copy()

                # 4) no ì¬ë¶€ì—¬ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
                sub = df_hr[df_hr["project_id"].astype(str)==str(proj_id)].copy()
                if not sub.empty and "no" in sub.columns:
                    sub = sub.sort_values("no").reset_index(drop=True)
                    sub["no"] = range(1, len(sub)+1)
                    df_hr.loc[df_hr["project_id"].astype(str)==str(proj_id), "no"] = sub["no"].values

                # 5) ì €ì¥
                _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)

                st.success("ì¸ë ¥ + íƒ€ì„ì‹œíŠ¸ ì‚­ì œ ì™„ë£Œ")  # ë©”ì‹œì§€ë„ ëª…í™•íˆ
                st.rerun()

    with btnB:
        if st.button("ğŸ’¾ ì¸ë ¥ê´€ë¦¬ ì €ì¥", key=k("hr","save_rows",proj_id)):
            apply_df = edited.drop(columns=["ì„ íƒ"], errors="ignore").copy()
            for i, r in apply_df.iterrows():
                ridx = hr_rows.index[i] if i < len(hr_rows) else None
                plan_mm = _calc_plan_mm(r.get("start_date",""), r.get("end_date",""), r.get("ratio",0))
                wage    = float(pd.to_numeric(r.get("wage",0), errors="coerce") or 0.0)

                rowval = {
                    "no": int(pd.to_numeric(r.get("no",0), errors="coerce") or 0),
                    "project_id": proj_id,
                    "project_name": safe_fmt_by(df_p,"project_id","name")(proj_id),
                    "member_name": _s(r.get("member_name","")),
                    "dept_role": _s(r.get("dept_role","")),
                    "grade_skill": _s(r.get("grade_skill","")),
                    "start_date": _safe_date_str(r.get("start_date","")),
                    "end_date": _safe_date_str(r.get("end_date","")),
                    "ratio": int(pd.to_numeric(r.get("ratio",0), errors="coerce") or 0),
                    "plan_mm": plan_mm,
                    "wage": int(wage),
                    "role": _s(r.get("role","")),
                    "main_task": _s(r.get("main_task","")),
                    "note": _s(r.get("note","")),
                }
                if ridx is None:
                    df_hr.loc[len(df_hr)] = {**{c:"" for c in base_cols}, **rowval}
                else:
                    for c,v in rowval.items():
                        if c in df_hr.columns: df_hr.loc[ridx, c] = v

            # íƒ€ì„ì‹œíŠ¸ í•©ê³„ë¡œ ì‹¤ì œ/ë¹„ìš© ê³„ì‚°
            sub = df_hr[df_hr["project_id"].astype(str)==str(proj_id)].copy()
            for idx, row in sub.iterrows():
                nm = _s(row.get("member_name",""))
                if not nm:
                    df_hr.loc[idx, ["real_mm","plan_cost","real_cost","mm_diff","cost_diff"]] = [0,0,0,0,0]
                    continue
                ts_rows_nm = df_ts[(df_ts["project_id"].astype(str)==str(proj_id)) & (df_ts["member_name"].astype(str)==nm)]
                real_mm = sum(float(pd.to_numeric(tr.get(f"ww{i}",0), errors="coerce") or 0.0)
                              for _, tr in ts_rows_nm.iterrows() for i in range(1,53))
                wage = float(pd.to_numeric(row.get("wage",0), errors="coerce") or 0.0)
                plan_mm = float(pd.to_numeric(row.get("plan_mm",0), errors="coerce") or 0.0)
                plan_cost = wage * plan_mm
                real_cost = wage * real_mm
                mm_diff   = plan_mm - real_mm
                cost_diff = plan_cost - real_cost
                for c,v in [("real_mm",real_mm),("plan_cost",plan_cost),
                            ("real_cost",real_cost),("mm_diff",mm_diff),("cost_diff",cost_diff)]:
                    if c in df_hr.columns: df_hr.loc[idx, c] = v

            _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
            st.success("ì¸ë ¥ê´€ë¦¬ ì €ì¥ ì™„ë£Œ")
            st.rerun()

    with btnC:
        sel_idx = edited.index[edited["ì„ íƒ"]==True].tolist()
        if st.button("âœï¸ ì„ íƒ ì¸ë ¥ ìˆ˜ì •", key=k("hr","edit_one_btn")):
            if len(sel_idx)!=1:
                st.warning("ìˆ˜ì •í•  ëŒ€ìƒì„ í•˜ë‚˜ë§Œ ì„ íƒí•˜ì„¸ìš”.")
            else:
                st.session_state[k("hr","edit_target")] = int(sel_idx[0])
                st.rerun()

    # ì„ íƒ ìˆ˜ì • í¼
    target = st.session_state.get(k("hr","edit_target"))
    if target is not None and 0 <= target < len(disp):
        row = disp.iloc[target]
        with st.expander(f"ì„ íƒ ì¸ë ¥ ìˆ˜ì •: {row.get('member_name','')}", expanded=True):
            c1,c2,c3 = st.columns(3)
            with c1:
                member_name = st.text_input("ì¸ë ¥ëª…", value=_s(row.get("member_name","")), key=k("hr","f_name"))
                dept_role   = st.text_input("ì†Œì†/ì§ë¬´", value=_s(row.get("dept_role","")), key=k("hr","f_dept"))
                grade_skill = st.text_input("ì§ê¸‰/ìŠ¤í‚¬", value=_s(row.get("grade_skill","")), key=k("hr","f_grade"))
            with c2:
                start_date  = st.date_input("íˆ¬ì…ì‹œì‘ì¼", value=_parse_date_maybe(row.get("start_date","")) or date.today(), key=k("hr","f_sd"))
                end_date    = st.date_input("íˆ¬ì…ì¢…ë£Œì¼", value=_parse_date_maybe(row.get("end_date","")) or start_date, key=k("hr","f_ed"))
                ratio       = st.number_input("íˆ¬ì…ë¥ (%)", 0, 100, int(pd.to_numeric(row.get("ratio",0), errors="coerce") or 0), key=k("hr","f_ratio"))
            with c3:
                wage        = st.number_input("ì¸ê±´ë¹„(KRW)", min_value=0, value=int(pd.to_numeric(row.get("wage",0), errors="coerce") or 0), step=1, key=k("hr","f_wage"))
                role        = st.selectbox("ì—­í• ", ["PM","PL","ê°œë°œ","ê¸°íš","QA"], index= ["PM","PL","ê°œë°œ","ê¸°íš","QA"].index(_s(row.get("role","PM"))) if _s(row.get("role","PM")) in ["PM","PL","ê°œë°œ","ê¸°íš","QA"] else 0, key=k("hr","f_role"))
                main_task   = st.text_input("ì£¼ìš”ì—…ë¬´", value=_s(row.get("main_task","")), key=k("hr","f_task"))

            plan_mm_calc = _calc_plan_mm(start_date, end_date, ratio)
            st.info(f"ìë™ê³„ì‚°ëœ ê³„íšê³µìˆ˜: **{plan_mm_calc:.2f} MM** (ì—…ë¬´ì¼/20 * íˆ¬ì…ë¥ )")

            colx, coly = st.columns([0.2, 0.8])
            with colx:
                if st.button("âœ… ì €ì¥", key=k("hr","f_save")):
                    ridx = hr_rows.index[target] if target < len(hr_rows) else None
                    if ridx is not None:
                        df_hr.loc[ridx, "member_name"] = _s(member_name)
                        df_hr.loc[ridx, "dept_role"]   = _s(dept_role)
                        df_hr.loc[ridx, "grade_skill"] = _s(grade_skill)
                        df_hr.loc[ridx, "start_date"]  = _safe_date_str(start_date)
                        df_hr.loc[ridx, "end_date"]    = _safe_date_str(end_date)
                        df_hr.loc[ridx, "ratio"]       = int(ratio)
                        df_hr.loc[ridx, "plan_mm"]     = plan_mm_calc
                        df_hr.loc[ridx, "wage"]        = int(wage)
                        df_hr.loc[ridx, "role"]        = _s(role)
                        df_hr.loc[ridx, "main_task"]   = _s(main_task)

                        # ë¹„ìš©/ì°¨ì´ ì¬ê³„ì‚°
                        real_mm = 0.0
                        ts_rows_nm = df_ts[(df_ts["project_id"].astype(str)==str(proj_id)) & (df_ts["member_name"].astype(str)==_s(member_name))]
                        for _, tr in ts_rows_nm.iterrows():
                            for i in range(1,53):
                                real_mm += float(pd.to_numeric(tr.get(f"ww{i}",0), errors="coerce") or 0.0)
                        plan_cost = int(wage) * plan_mm_calc
                        real_cost = int(wage) * real_mm
                        df_hr.loc[ridx, "real_mm"]  = real_mm
                        df_hr.loc[ridx, "plan_cost"]= plan_cost
                        df_hr.loc[ridx, "real_cost"]= real_cost
                        df_hr.loc[ridx, "mm_diff"]  = plan_mm_calc - real_mm
                        df_hr.loc[ridx, "cost_diff"]= plan_cost - real_cost

                        _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                        st.session_state.pop(k("hr","edit_target"), None)
                        st.success("ì„ íƒ ì¸ë ¥ ìˆ˜ì • ì €ì¥ ì™„ë£Œ")
                        st.rerun()

            with coly:
                if st.button("ì·¨ì†Œ", key=k("hr","f_cancel")):
                    st.session_state.pop(k("hr","edit_target"), None)
                    st.rerun()

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€ íƒ€ì„ì‹œíŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€
    st.markdown("---")
    st.markdown("### â± íƒ€ì„ì‹œíŠ¸ (ì£¼ë‹¹ ìµœëŒ€ 0.25MM)")

    # í˜„ì¬ í”„ë¡œì íŠ¸ì˜ ì¸ë ¥ ëª…ë‹¨(ì €ì¥ ìˆœ)
    hr_rows = df_hr[df_hr["project_id"].astype(str)==str(proj_id)].copy()
    if "no" in hr_rows.columns:
        hr_rows["no"] = pd.to_numeric(hr_rows["no"], errors="coerce").fillna(0).astype(int)
        hr_rows = hr_rows.sort_values("no")
    hr_names = hr_rows.get("member_name", pd.Series([], dtype=str)).astype(str).map(_s).tolist()

    # (A) íƒ€ì„ì‹œíŠ¸ ë¸”ë¡ ë³´ì¥: í”„ë¡œì íŠ¸ ì‹œì‘/ì¢…ë£Œì¼ ê¸°ì¤€ìœ¼ë¡œ -26ì£¼ ~ +52ì£¼
    #     â†’ ìƒˆë¡œ ì¶”ê°€ëœ ì¸ì›ë„ ì—¬ê¸°ì„œ 'í–‰'ì´ ë°˜ë“œì‹œ ìƒì„±ë¨
    for nm in hr_names:
        if nm:
            df_ts = _ensure_timesheet_blocks(df_ts, str(proj_id), _s(nm), proj_start_p, proj_end_p)

    # (B) ì´ í”„ë¡œì íŠ¸ì˜ ì „ì²´ íƒ€ì„ì‹œíŠ¸(ì •ê·œí™” í›„ ë¸”ë¡ ëª©ë¡)
    ts_all = _normalize_ts(df_ts[df_ts["project_id"].astype(str)==str(proj_id)])
    blocks = sorted([b for b in ts_all["_block_date"].dropna().unique().tolist()])
    if not blocks:
        st.info("íƒ€ì„ì‹œíŠ¸ ë¸”ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì¸ë ¥/ê¸°ê°„ì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.")
        st.stop()

    # (C) ê¸ˆì£¼ í¬í•¨ ë¸”ë¡ ìœ ì§€(ì„¸ì…˜)
    today = date.today()
    sess_block_key = k("hr","ts_block",proj_id)
    if sess_block_key not in st.session_state or st.session_state[sess_block_key] not in blocks:
        st.session_state[sess_block_key] = _pick_block_for_date(blocks, today)
    block_sel: date = st.session_state[sess_block_key]

    # (D) ê¸ˆì£¼ë¡œ ì´ë™ ë²„íŠ¼





    


    navL, navR = st.columns([0.75, 0.25])
    with navR:
        if st.button("â® ê¸ˆì£¼ë¡œ ì´ë™", key=k("hr","goto_today",proj_id)):
            st.session_state[sess_block_key] = _pick_block_for_date(blocks, today)
            st.rerun()

    # (E) ì„ íƒ ë¸”ë¡ì˜ 52ì£¼ ì›”ìš”ì¼
    wms = _week_mondays_of_block(block_sel)

    # (F) ê¸ˆì£¼ ì—´ ê³„ì‚° (ë¸”ë¡ ì•ˆì´ë©´ í•´ë‹¹ ì£¼)
    def _week_idx(mondays, d):
        for i, m in enumerate(mondays, start=1):
            if m <= d <= m + timedelta(days=6):
                return i
        return 1 if d < mondays[0] else 52
    in_block = (block_sel <= today < block_sel + timedelta(weeks=52))
    focus = _week_idx(wms, today) if in_block else 1

    # (G) ì´ë²ˆ ì£¼ 1ì—´ íšŒì „(ì›í•˜ë©´ ì‚¬ìš©) â€” ì§€ê¸ˆì€ ì‚¬ìš©ì ìš”ì²­ëŒ€ë¡œ ìì—° ìŠ¤í¬ë¡¤ë§Œ: 1..52
    rotated = [f"ww{i}" for i in range(1,53)]

    # (H) ë¼ë²¨: ê°„ê²°í•˜ê²Œ Wxx (MM/DD)
    def _first_monday(y):
        d0 = date(y,1,1)
        return d0 if d0.weekday()==0 else d0 + timedelta(days=(7-d0.weekday()))
    def _year_week_label(m):
        y = m.year; f = _first_monday(y)
        return (y, 0 if m<f else 1 + ((m-f).days//7))
    ordered_wms = [wms[int(c[2:])-1] for c in rotated]
    colcfg_ts = {}
    for c, wm in zip(rotated, ordered_wms):
        _, wk = _year_week_label(wm)
        colcfg_ts[c] = st.column_config.NumberColumn(
            f"W{wk:02d} ({wm.strftime('%m/%d')})", min_value=0.0, max_value=0.25, step=0.05
        )

    # (I) í¸ì§‘ìš© DF(í–‰=ì¸ë ¥) êµ¬ì„±
    proj_rows = ts_all[ts_all["_block_date"]==block_sel]
    by_name = {_s(r["member_name"]): r for _, r in proj_rows.iterrows()}
    base_rows = []
    for nm in hr_names:
        row = {"member_name": nm}
        src = by_name.get(_s(nm), {})
        for i in range(1,53):
            row[f"ww{i}"] = float(pd.to_numeric(src.get(f"ww{i}",0), errors="coerce") or 0.0)
        base_rows.append(row)
    ts_df = pd.DataFrame(base_rows)



    # ì¢Œ: ì´ë¦„(ê³ ì •) / ìš°: ì£¼ì°¨ ì—ë””í„°
    left, right = st.columns([0.18, 0.82], gap="small")

    with left:
        st.data_editor(
            pd.DataFrame({"ì¸ë ¥": hr_names}),
            column_config={"ì¸ë ¥": st.column_config.TextColumn("ì¸ë ¥", disabled=True)},
            width='stretch', height=300, hide_index=True,
            key=k("hr","names",proj_id)
        )

    with right:
    # ---- íƒ€ì„ì‹œíŠ¸ í‘œì‹œìš© ë°ì´í„° êµ¬ì„± (hr_names ìˆœì„œ ê³ ì •) ----
        cols_weeks = [f"ww{i}" for i in range(1, 53)]
        ts_display = ts_df[cols_weeks].fillna(0.0)

        # ---- ì»¬ëŸ¼ ì„¤ì •: WW + ì›”ìš”ì¼ ë‚ ì§œ í‘œì‹œ ----
        week_mondays = _week_mondays_of_block(block_sel)   # â† ì´ë¯¸ ì •ì˜ëœ í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©
        def _hdr(i, d):
            # ì˜ˆ: "WW01 â€¢ 03/03 (ì›”)"  (í•„ìš”ì‹œ '%Y-%m-%d' ë¡œ ë³€ê²½)
            return f"WW{i:02d} â€¢ {d.strftime('%m/%d')} (ì›”)"

        colcfg_ts_full = {
            w: st.column_config.NumberColumn(
                _hdr(i, d),
                step=0.25,
                min_value=0.0,
                help=f"WW{i:02d} / ì£¼ ì‹œì‘ì¼: {d.strftime('%Y-%m-%d')}"
            )
            for i, (w, d) in enumerate(zip(cols_weeks, week_mondays), start=1)
        }

        # ---- ë°ì´í„° ì—ë””í„° ----
        ts_edit = st.data_editor(
            ts_display,
            column_config=colcfg_ts_full,
            column_order=cols_weeks,
            height=400,
            hide_index=True,
            use_container_width=True,
            key=k("hr","ts",proj_id, block_sel)
        )






    # with right:
    #     # ---- íƒ€ì„ì‹œíŠ¸ í‘œì‹œìš© ë°ì´í„° êµ¬ì„± ----
    #     df_ts_block = df_ts[
    #         (df_ts["project_id"].astype(str) == str(proj_id)) &
    #         (pd.to_datetime(df_ts["block_start"], errors="coerce").dt.date == block_sel)
    #     ].copy()

    #     if df_ts_block.empty:
    #         df_ts_block = pd.DataFrame(columns=["member_name"] + [f"ww{i}" for i in range(1, 53)])

    #     # âœ… ì—ë””í„°ì— í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ë³´ì—¬ì£¼ê¸°
    #     cols_weeks = [f"ww{i}" for i in range(1, 53)]
    #     show_cols = ["member_name"] + cols_weeks
    #     ts_display = df_ts_block.reindex(columns=show_cols).fillna(0.0)

        # ---- ì»¬ëŸ¼ ì„¤ì • ----
        
        # ---- ì»¬ëŸ¼ ì„¤ì • (WW + ì›”ìš”ì¼ ë‚ ì§œ ë³‘ê¸°) ----
        week_mondays = _week_mondays_of_block(block_sel)   # â† ì´ë¯¸ íŒŒì¼ ìƒë‹¨ì—ì„œ ì •ì˜ë¨

        def _hdr(i, d):
            # ì˜ˆ: "WW01 â€¢ 03/03 (ì›”)"
            return f"WW{i:02d} â€¢ {d.strftime('%m/%d')} (ì›”)"

        colcfg_ts_full = {
            "member_name": st.column_config.TextColumn("ì´ë¦„", disabled=True),
            **{
                col: st.column_config.NumberColumn(
                    _hdr(i, d), step=0.25, min_value=0.0,
                    help=f"WW{i:02d} / ì£¼ ì‹œì‘ì¼: {d.strftime('%Y-%m-%d')}"
                )
                for i, (col, d) in enumerate(zip(cols_weeks, week_mondays), start=1)
            }
        }

        
        
        # colcfg_ts_full = {
        #     "member_name": st.column_config.TextColumn("ì´ë¦„", disabled=True),
        #     **{ w: st.column_config.NumberColumn(w.upper(), step=0.25, min_value=0.0) for w in cols_weeks }
        # }

        # ts_edit = st.data_editor(
        #     ts_display,                      # ì´ë¯¸ fillna ì ìš©
        #     column_config=colcfg_ts_full,
        #     column_order=show_cols,          # âœ… ìˆœì„œ ê³ ì •
        #     disabled=[],                     # í•„ìš” ì‹œ íŠ¹ì • ì£¼ì°¨ ë¹„í™œì„±í™” ê°€ëŠ¥
        #     height=400,
        #     hide_index=True,
        #     use_container_width=True,
        #     key=k("hr","ts",proj_id, block_sel)   # âœ… ë¸”ë¡ê¹Œì§€ í¬í•¨í•´ ê³ ìœ í™”
        # )



    # # ì¢Œ: ì´ë¦„(ê³ ì •) / ìš°: ì£¼ì°¨ ì—ë””í„°
    # left, right = st.columns([0.18, 0.82], gap="small")
    # with left:
    #     st.data_editor(pd.DataFrame({"ì¸ë ¥": hr_names}),
    #                    column_config={"ì¸ë ¥": st.column_config.TextColumn("ì¸ë ¥", disabled=True)},
    #                    width='stretch', height=300, hide_index=True, key=k("hr","names",proj_id))
    # with right:
    #     # ---- íƒ€ì„ì‹œíŠ¸ í‘œì‹œìš© ë°ì´í„° êµ¬ì„± ----
    #     df_ts_block = df_ts[
    #         (df_ts["project_id"].astype(str) == str(proj_id)) &
    #         (pd.to_datetime(df_ts["block_start"], errors="coerce").dt.date == block_sel)
    #     ].copy()

    #     if df_ts_block.empty:
    #         df_ts_block = pd.DataFrame(
    #             columns=["member_name"] + [f"ww{i}" for i in range(1, 53)]
    #         )

    #     ts_display = df_ts_block.fillna(0.0)

    #     # ---- ì»¬ëŸ¼ ì„¤ì • ----
    #     colcfg_ts_full = {
    #         "member_name": st.column_config.TextColumn("ì´ë¦„", disabled=True),
    #         **{
    #             f"ww{i}": st.column_config.NumberColumn(f"WW{i}", step=0.25, min_value=0.0)
    #             for i in range(1, 53)
    #         }
    #     }


    #     ts_edit = st.data_editor(
    #         ts_display.fillna(0.0),              # âœ… None ë°©ì§€(ë³´ì´ëŠ” ê°’ë„ 0.0)
    #     column_config=colcfg_ts_full,
    #     height=400,
    #     hide_index=True,
    #     use_container_width=True,
    #     key=k("hr","ts",proj_id, block_sel)  # âœ… ë¸”ë¡ê¹Œì§€ í¬í•¨í•´ ê³ ìœ í™”
    #     )   

    # (J) ì €ì¥: **ìƒˆë¡œ ì¶”ê°€ëœ ì¸ì›ë„ ë°˜ë“œì‹œ ì €ì¥ë˜ë„ë¡** ë§ˆìŠ¤í¬ë¥¼ ì•ˆì •ì ìœ¼ë¡œ êµ¬ì„±
    # === íƒ€ì„ì‹œíŠ¸ ì €ì¥ (REPLACE this block) ===
    if st.button("ğŸ’¾ íƒ€ì„ì‹œíŠ¸ ì €ì¥", key=k("hr","ts_save",proj_id)):
        # 0) ìš°ì„  í˜„ì¬ ë³´ì´ëŠ” block_selì´ ìˆëŠ”ì§€ ëª¨ë“  ì¸ì›ì— ëŒ€í•´ 'í–‰'ì„ ë³´ì¥
        for nm in hr_names:
            if nm:
                df_ts = _ensure_timesheet_blocks(df_ts, str(proj_id), _s(nm), proj_start_p, proj_end_p)

        # 1) í¸ì§‘ê°’ì„ í˜„ì¬ block_selì— ì •í™•íˆ ì¨ë„£ê¸°
        blk_dates = pd.to_datetime(df_ts["block_start"], errors="coerce").dt.date
        for rix, nm in enumerate(hr_names):
            if not nm:
                continue

            # (1) ëŒ€ìƒ í–‰ ë§ˆìŠ¤í¬
            row_mask = (
                (df_ts["project_id"].astype(str) == str(proj_id)) &
                (df_ts["member_name"].astype(str) == _s(nm)) &
                (blk_dates == block_sel)
            )

            # (2) í˜¹ì‹œë¼ë„ í–‰ì´ ì—†ë‹¤ë©´: ì¦‰ì„ ìƒì„± í›„ ë§ˆìŠ¤í¬ ê°±ì‹ 
            if not row_mask.any():
                # block_sel 1ì¤„ë§Œ ì¦‰ì„ ìƒì„±
                add = {"project_id": str(proj_id), "member_name": _s(nm), "block_start": block_sel.strftime("%Y-%m-%d")}
                for i in range(1,53):
                    add[f"ww{i}"] = 0.0
                df_ts.loc[len(df_ts)] = add
                blk_dates = pd.to_datetime(df_ts["block_start"], errors="coerce").dt.date
                row_mask = (
                    (df_ts["project_id"].astype(str) == str(proj_id)) &
                    (df_ts["member_name"].astype(str) == _s(nm)) &
                    (blk_dates == block_sel)
                )

            # (3) íšŒì „ëœ ì»¬ëŸ¼ë“¤ ê°’ì„ ww1..ww52ë¡œ ë§¤í•‘í•´ ì €ì¥ (0.00~0.25)
            for c in rotated:
                i = int(c[2:])
                v = float(pd.to_numeric(ts_edit.iloc[rix][c], errors="coerce") or 0.0)
                v = max(0.0, min(0.25, v))
                df_ts.loc[row_mask, f"ww{i}"] = v

        # 2) dtypeì„ **float**ë¡œ í™•ì • (ì¤‘ìš”! intë¡œ ë‚¨ìœ¼ë©´ 0.25ê°€ 0ìœ¼ë¡œ ë³´ì´ëŠ” ì¼ì´ ìƒê¹€)
        for i in range(1,53):
            col = f"ww{i}"
            df_ts[col] = pd.to_numeric(df_ts[col], errors="coerce").fillna(0.0).astype(float)

        # 3) HR í•©ê³„(ì‹¤MM/ë¹„ìš©) ì¦‰ì‹œ ì¬ê³„ì‚°
        sub = df_hr[df_hr["project_id"].astype(str)==str(proj_id)].copy()
        for idx, row in sub.iterrows():
            nm = _s(row.get("member_name",""))
            if not nm:
                df_hr.loc[idx, ["real_mm","plan_cost","real_cost","mm_diff","cost_diff"]] = [0,0,0,0,0]
                continue

            nm_mask = (
                (df_ts["project_id"].astype(str) == str(proj_id)) &
                (df_ts["member_name"].astype(str) == nm)
            )
            real_mm = 0.0
            for rix, hr_nm in enumerate(hr_names):
                if _s(hr_nm) == nm and rix < len(ts_edit):
                    # ts_editì—ì„œ ì§ì ‘ ì½ê¸° (íšŒì „ëœ ì»¬ëŸ¼ ìˆœì„œëŒ€ë¡œ)
                    for c in rotated:
                        val = float(pd.to_numeric(ts_edit.iloc[rix][c], errors="coerce") or 0.0)
                        real_mm += max(0.0, min(0.25, val))
                    break


            wage    = float(pd.to_numeric(row.get("wage",0), errors="coerce") or 0.0)
            plan_mm = float(pd.to_numeric(row.get("plan_mm",0), errors="coerce") or 0.0)
            plan_cost = wage * plan_mm
            real_cost = wage * real_mm
            mm_diff   = plan_mm - real_mm
            cost_diff = plan_cost - real_cost

            for c,v in [("real_mm",real_mm),("plan_cost",plan_cost),
                        ("real_cost",real_cost),("mm_diff",mm_diff),("cost_diff",cost_diff)]:
                if c in df_hr.columns:
                    df_hr.loc[idx, c] = v

        # 4) ì €ì¥
        _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
        st.success("íƒ€ì„ì‹œíŠ¸ ì €ì¥ ë° í•©ê³„ ê°±ì‹  ì™„ë£Œ")
        st.rerun()
# ====== /HR íƒ­ ë ======












































# â”€â”€â”€â”€â”€â”€â”€â”€â”€ Tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_tasks:
    st.subheader("ì‘ì—… ëª©ë¡")
    if df_p.empty:
        st.info("ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.")
    else:
        # ìƒíƒœí‚¤ ì´ˆê¸°í™”
        st.session_state.setdefault(k("task","show_form"), False)
        st.session_state.setdefault(k("task","do_scroll"), False)

        project_choice = st.selectbox(
            "í”„ë¡œì íŠ¸ ì„ íƒ",
            options=safe_select_options(df_p["project_id"]),
            format_func=safe_fmt_by(df_p, "project_id", "name"),
            key=k("task","proj_choice")
        )

        # --- [ADD] í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ HR ì¸ë ¥ëª… ëª©ë¡ ì¶”ì¶œ ---
        hr_names = (
            df_hr.loc[df_hr["project_id"].astype(str) == project_choice, "member_name"]
            .dropna()
            .astype(str)
            .map(_s).map(str.strip)
            .replace("", np.nan).dropna()
            .unique().tolist()
        )
        hr_names = sorted(hr_names)
        # -----------------------------------------------

        b1, b2, _sp = st.columns([0.22,0.22,0.56], gap="small")
        with b1:
            if st.button("â• ì‘ì—… ì¶”ê°€/ìˆ˜ì •", key=k("task","open_form_btn")):
                st.session_state[k("task","show_form")] = True
                st.session_state[k("task","do_scroll")] = True
                st.rerun()
        with b2:
            if st.button("ğŸ—‘ ì„ íƒ ì‚­ì œ", key=k("task","bulk_delete_btn")):
                st.session_state[k("task","trigger_delete")] = True

        st.divider()
        st.markdown("### ì„ íƒ í”„ë¡œì íŠ¸ì˜ ì‘ì—…í‘œ")

        tshow = df_t[df_t["project_id"].astype(str) == project_choice].copy()
        status_icon_map = {"Done":"ğŸŸ¢","In Progress":"ğŸ”µ","Blocked":"ğŸ”´","To Do":"âšª"}

        if not tshow.empty:
            tshow.insert(0, "No", range(1, len(tshow)+1))
            tshow.insert(0, "ì„ íƒ", False)
            tshow["ìƒíƒœ(ìƒ‰)"] = tshow["status"].map(status_icon_map).fillna("ğŸŸ ")
            tshow = tshow.dropna(axis=1, how="all")
            base_cols = ["project_id","task_id","title","assignee","priority","status","ìƒíƒœ(ìƒ‰)","progress","start_date","due_date","estimate_days","labels","description"]
            ordered = ["ì„ íƒ","No"] + [c for c in base_cols if c in tshow.columns] + [c for c in tshow.columns if c not in (["ì„ íƒ","No"] + base_cols)]

            edited = st.data_editor(
                tshow[ordered],
                column_config={
                    "ì„ íƒ":     st.column_config.CheckboxColumn("ì„ íƒ", width="small"),
                    "progress": st.column_config.NumberColumn("ì§„í–‰ë¥ (%)", min_value=0, max_value=100, step=1, help="ì½ê¸°í‘œì‹œ(í¼ì—ì„œ í¸ì§‘)"),
                    "ìƒíƒœ(ìƒ‰)": st.column_config.TextColumn("ìƒíƒœ(ìƒ‰ìƒ)", disabled=True),
                },
                disabled=[c for c in ordered if c not in ["ì„ íƒ"]],
                width='stretch', height=420, hide_index=True,
                key=k("task","editor","list",project_choice)
            )
            selected_tids = edited.loc[edited["ì„ íƒ"] == True, "task_id"].astype(str).tolist() if "task_id" in edited.columns else []
        else:
            st.info("í‘œì‹œí•  ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.")
            selected_tids = []

        if st.session_state.get(k("task","trigger_delete"), False):
            st.session_state[k("task","trigger_delete")] = False
            if not selected_tids:
                st.warning("ì„ íƒëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.")
            else:
                st.session_state[k("task","pending_delete_tids")] = selected_tids
                st.session_state[k("task","show_confirm")] = True
                st.rerun()

        if st.session_state.get(k("task","show_confirm"), False):
            pending = st.session_state.get(k("task","pending_delete_tids"), [])
            st.warning(f"ì„ íƒí•œ {len(pending)}ê°œ ì‘ì—…ì„ ì‚­ì œí•˜ê³  task_idë¥¼ ì „ì²´ ì¬ì±„ë²ˆí•©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
            cA, cB = st.columns([1,1])
            with cA:
                if st.button("âœ… ì˜ˆ, ì‚­ì œí•©ë‹ˆë‹¤", key=k("task","bulk_delete_yes")):
                    tids = [str(x) for x in pending]
                    df_t = df_t[~df_t["task_id"].astype(str).isin(tids)]
                    df_c = df_c[~((df_c["entity_type"].astype(object).map(_s).str.lower()=="task") & (df_c["entity_id"].astype(object).map(_s).isin(tids)))]
                    df_t, df_c = _renumber_project_tasks(df_t, df_c, project_choice)
                    _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                    st.session_state[k("task","pending_delete_tids")] = []
                    st.session_state[k("task","show_confirm")] = False
                    st.success("ì‘ì—… ì‚­ì œ ë° ì¬ì±„ë²ˆ ì™„ë£Œ")
                    st.rerun()
            with cB:
                if st.button("ì·¨ì†Œ", key=k("task","bulk_delete_cancel")):
                    st.session_state[k("task","show_confirm")] = False
                    st.info("ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
                    st.rerun()

        st.divider()
        show_form = st.session_state.get(k("task","show_form"), False)
        if show_form:
            st.markdown("<div id='taskform'></div>", unsafe_allow_html=True)
            if st.session_state.get(k("task","do_scroll"), False):
                scroll_to("taskform")
                st.session_state[k("task","do_scroll")] = False

            st.markdown("### ì‘ì—… ì¶”ê°€/ìˆ˜ì •")
            if st.button("ë‹«ê¸°", key=k("task","close_form")):
                st.session_state[k("task","show_form")] = False
                st.rerun()

            edit_task_mode = st.toggle("ì‘ì—… ìˆ˜ì • ëª¨ë“œ", value=False, key=k("task","edit_mode"))
            project_tasks = df_t[df_t["project_id"].astype(str) == project_choice].copy()

            selected_task_id = None
            if edit_task_mode and not project_tasks.empty:
                # ì•ˆì „ í¬ë§·
                selected_task_id = st.selectbox(
                    "ìˆ˜ì •í•  ì‘ì—…",
                    options=safe_select_options(project_tasks["task_id"]),
                    format_func=safe_fmt_by(project_tasks, "task_id", "title"),
                    key=k("task","select_edit",project_choice)
                )

            title_key       = k("task","title")
            desc_key        = k("task","desc")
            assignee_key    = k("task","assignee")
            priority_key    = k("task","priority")
            status_key      = k("task","status")
            progress_key    = k("task","progress")
            prev_status_key = k("task","prev_status")
            start_key       = k("task","start")
            due_key         = k("task","due")
            est_key         = k("task","estimate_workdays", project_choice)
            prev_sel_key    = k("task","prev_selected")

            if edit_task_mode and selected_task_id:
                last_selected = st.session_state.get(prev_sel_key)
                if (last_selected != selected_task_id):
                    row = project_tasks[project_tasks["task_id"].astype(str) == selected_task_id].iloc[0].to_dict()
                    st.session_state[title_key]    = _s(row.get("title",""))
                    st.session_state[desc_key]     = _s(row.get("description",""))
                    st.session_state[assignee_key] = _s(row.get("assignee",""))
                    pr = _s(row.get("priority","Medium"))
                    st.session_state[priority_key] = pr if pr in TASK_PRIORITY_OPTIONS else "Medium"
                    cur_status = _s(row.get("status","To Do"))
                    if cur_status not in TASK_STATUS_OPTIONS: cur_status = "To Do"
                    st.session_state[status_key]   = cur_status
                    st.session_state[prev_status_key] = cur_status
                    try:
                        st.session_state[progress_key] = int(pd.to_numeric(row.get("progress", 0), errors="coerce"))
                    except Exception:
                        st.session_state[progress_key] = 0
                    sd = _safe_date_str(row.get("start_date",""))
                    dd = _safe_date_str(row.get("due_date",""))
                    st.session_state[start_key] = parse_dt(sd).date() if sd else date.today()
                    st.session_state[due_key]   = parse_dt(dd).date() if dd else date.today()
                    try:
                        est_val = float(pd.to_numeric(row.get("estimate_days", np.nan), errors="coerce"))
                    except Exception:
                        est_val = np.nan
                    if pd.isna(est_val):
                        est_val = float(business_days_inclusive(st.session_state[start_key], st.session_state[due_key]))
                    st.session_state[est_key] = float(est_val)
                    st.session_state[prev_sel_key] = selected_task_id

            if not edit_task_mode and st.session_state.get(prev_sel_key) is not None:
                st.session_state.pop(prev_sel_key, None)
            if not edit_task_mode:
                st.session_state.setdefault(title_key, "")
                st.session_state.setdefault(desc_key, "")
                st.session_state.setdefault(assignee_key, "")
                st.session_state.setdefault(priority_key, "Medium")
                st.session_state.setdefault(status_key, "To Do")
                st.session_state.setdefault(prev_status_key, "To Do")
                st.session_state.setdefault(progress_key, 0)
                st.session_state.setdefault(start_key, date.today())
                st.session_state.setdefault(due_key, date.today())
                st.session_state[est_key] = float(business_days_inclusive(st.session_state[start_key], st.session_state[due_key]))

            def _on_status_change():
                cur = st.session_state[status_key]
                prev = st.session_state.get(prev_status_key, cur)
                if cur == "Done":
                    st.session_state[progress_key] = 100
                elif prev == "Done" and cur != "Done":
                    st.session_state[progress_key] = 0
                st.session_state[prev_status_key] = cur

            def _on_progress_change():
                try: p = int(st.session_state[progress_key])
                except Exception: p = 0
                p = max(0, min(100, p))
                st.session_state[progress_key] = p
                if p == 100:
                    st.session_state[status_key] = "Done"

            title       = st.text_input("Title", value=st.session_state.get(title_key, ""), key=title_key)
            description = st.text_area("Description", height=120, value=st.session_state.get(desc_key, ""), key=desc_key)




            
            #assignee    = st.text_input("Assignee", value=st.session_state.get(assignee_key, ""), key=assignee_key)

            # --- [REPLACE] Assignee: HR ëª…ë‹¨ ê¸°ë°˜ ì„ íƒ/ì„ì‹œ ì…ë ¥ ---
            prev_assignee = _s(st.session_state.get(assignee_key, ""))

            if hr_names:
                # ê¸°ì¡´ ê°’ì´ ëª…ë‹¨ì— ì—†ìœ¼ë©´ ë³´ì¡´ ì„ íƒì§€ë¡œ í¬í•¨
                options = hr_names.copy()
                if prev_assignee and prev_assignee not in options:
                    options = [prev_assignee] + [n for n in options if n != prev_assignee]

                try:
                    idx = options.index(prev_assignee) if prev_assignee else 0
                except ValueError:
                    idx = 0

                st.selectbox(
                    "Assignee",
                    options=options,
                    index=idx if options else 0,
                    key=assignee_key,
                    help="ì¸ë ¥ê´€ë¦¬ íƒ­ì— ë“±ë¡ëœ ì„±ëª…ì—ì„œ ì„ íƒí•˜ì„¸ìš”."
                )
            else:
                st.info("ì´ í”„ë¡œì íŠ¸ì˜ ì¸ë ¥ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤. â€˜ğŸ‘¥ Human Resourcesâ€™ íƒ­ì—ì„œ ë¨¼ì € ì¸ë ¥ì„ ë“±ë¡í•˜ì„¸ìš”.")
                st.text_input("Assignee (ì„ì‹œ ì§ì ‘ì…ë ¥)", value=prev_assignee, key=assignee_key)
            # --------------------------------------------------------










            default_priority = st.session_state.get(priority_key, "Medium")
            priority = st.selectbox(
                "Priority",
                options=TASK_PRIORITY_OPTIONS,
                index=TASK_PRIORITY_OPTIONS.index(default_priority) if default_priority in TASK_PRIORITY_OPTIONS else 1,
                key=priority_key
            )
            status = st.selectbox("Status", options=TASK_STATUS_OPTIONS,
                                  index=TASK_STATUS_OPTIONS.index(st.session_state.get(status_key,"To Do")),
                                  key=status_key, on_change=_on_status_change)

            start_date = st.date_input("Start Date", value=st.session_state.get(start_key, date.today()), key=start_key)
            due_date   = st.date_input("Due Date",   value=st.session_state.get(due_key, date.today()), key=due_key)

            # ë‚ ì§œ ìœ íš¨ì„±: Due >= Start
            calc_days = business_days_inclusive(start_date, due_date)
            invalid = False
            if due_date < start_date:
                st.error("âš ï¸ ì¢…ë£Œì¼(Due Date)ì€ ì‹œì‘ì¼(Start Date)ë³´ë‹¤ ì´ì „ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                invalid = True

            if not edit_task_mode:
                st.session_state[est_key] = float(calc_days)
            st.number_input("Estimate (ì—…ë¬´ì¼)", min_value=0.0, step=0.5, key=est_key)
            st.number_input("ì§„í–‰ë¥ (%)", min_value=0, max_value=100, step=1, key=progress_key, on_change=_on_progress_change)

            if edit_task_mode and selected_task_id:
                cols = st.columns(2)
                with cols[0]:
                    if st.button("ì €ì¥(ìˆ˜ì •)", key=k("task","save_edit",selected_task_id)):
                        if invalid:
                            st.warning("ì…ë ¥ ì˜¤ë¥˜ë¥¼ ë¨¼ì € ìˆ˜ì •í•˜ì„¸ìš”.")
                        else:
                            df_t.loc[df_t["task_id"].astype(str) == str(selected_task_id), [
                                "title","description","assignee","priority","status",
                                "start_date","due_date","estimate_days","progress"
                            ]] = [
                                st.session_state[title_key],
                                st.session_state[desc_key],
                                st.session_state[assignee_key],
                                st.session_state[priority_key],
                                st.session_state[status_key],
                                _safe_date_str(start_date),
                                _safe_date_str(due_date),
                                float(st.session_state[est_key]),
                                int(st.session_state[progress_key]),
                            ]
                            _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                            st.success("ì‘ì—…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
                            st.rerun()
                with cols[1]:
                    if st.button("ì‚­ì œ(ì‘ì—…)", key=k("task","delete",selected_task_id)):
                        df_t = df_t[df_t["task_id"].astype(str) != str(selected_task_id)]
                        df_c = df_c[~((df_c["entity_type"].astype(object).map(_s).str.lower()=="task") & (df_c["entity_id"].astype(object).map(_s) == str(selected_task_id)))]
                        df_t, df_c = _renumber_project_tasks(df_t, df_c, project_choice)
                        _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                        st.success("ì‘ì—…ì´ ì‚­ì œë˜ì—ˆê³  task_idë¥¼ ì¬ì±„ë²ˆí–ˆìŠµë‹ˆë‹¤.")
                        st.rerun()
            else:
                if st.button("ì¶”ê°€(ì‹ ê·œ ì‘ì—…)", key=k("task","add_new")):
                    if invalid:
                        st.warning("ì…ë ¥ ì˜¤ë¥˜ë¥¼ ë¨¼ì € ìˆ˜ì •í•˜ì„¸ìš”.")
                    elif not st.session_state[title_key]:
                        st.error("Titleì€ í•„ìˆ˜ì…ë‹ˆë‹¤.")
                    else:
                        new_tid = _next_project_task_id(df_t, project_choice)
                        df_t.loc[len(df_t)] = {
                            "task_id": new_tid, "project_id": project_choice,
                            "title": st.session_state[title_key],
                            "description": st.session_state[desc_key],
                            "assignee": st.session_state[assignee_key],
                            "priority": st.session_state[priority_key],
                            "status": st.session_state[status_key],
                            "start_date": _safe_date_str(start_date),
                            "due_date": _safe_date_str(due_date),
                            "estimate_days": float(st.session_state[est_key]),
                            "progress": int(st.session_state[progress_key]),
                            "labels": "",
                            "parent_task_id": ""
                        }
                        _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                        st.success(f"ì‘ì—… ì¶”ê°€ ì™„ë£Œ: {new_tid}")
                        st.rerun()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ Kanban â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_board:
    st.subheader("ì¹¸ë°˜ ë³´ë“œ")
    if df_p.empty:
        st.info("ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.")
    else:
        project_choice = st.selectbox(
            "í”„ë¡œì íŠ¸ ì„ íƒ (ì¹¸ë°˜)",
            options=safe_select_options(df_p["project_id"]),
            format_func=safe_fmt_by(df_p, "project_id", "name"),
            key=k("kanban","proj_choice")
        )
        board = df_t[df_t["project_id"].astype(str) == project_choice]
        cols = st.columns(len(TASK_STATUS_OPTIONS))
        for i, st_name in enumerate(TASK_STATUS_OPTIONS):
            with cols[i]:
                st.markdown(f"### {st_name}")
                col_df = board[board["status"] == st_name]
                for _, r in col_df.iterrows():
                    with st.container(border=True):
                        st.markdown(f"**#{_s(r['task_id'])}**  {_s(r['title'])}")
                        if _s(r.get("assignee","")):
                            st.caption(f"ë‹´ë‹¹: {_s(r['assignee'])}")
                        due = _safe_date_str(r.get("due_date",""))
                        if due: st.caption(f"ë§ˆê°: {due}")
                        new_status = st.selectbox(
                            "ìƒíƒœ ë³€ê²½", options=TASK_STATUS_OPTIONS,
                            index=TASK_STATUS_OPTIONS.index(st_name),
                            key=k("kanban","move",project_choice,_s(r["task_id"]))
                        )
                        if new_status != st_name:
                            if st.button(f"ë³€ê²½ ì €ì¥ #{_s(r['task_id'])}", key=k("kanban","save",_s(r["task_id"]))):
                                df_t.loc[df_t["task_id"] == r["task_id"], ["status"]] = [new_status]
                                _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                                st.success("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.")
                                st.rerun()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ Gantt â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_gantt:
    st.subheader("ê°„ë‹¨ ê°„íŠ¸ (Start~Due)")
    if df_p.empty:
        st.info("ë¨¼ì € í”„ë¡œì íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.")
    else:
        project_choice = st.selectbox(
            "í”„ë¡œì íŠ¸ ì„ íƒ (ê°„íŠ¸)",
            options=safe_select_options(df_p["project_id"]),
            format_func=safe_fmt_by(df_p, "project_id", "name"),
            key=k("gantt","proj_choice")
        )
        g = df_t[df_t["project_id"].astype(str) == project_choice].copy()
        if g.empty:
            st.info("í‘œì‹œí•  ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.")
        else:
            g["start_date_parsed"] = pd.to_datetime(g["start_date"], errors="coerce")
            g["due_date_parsed"]   = pd.to_datetime(g["due_date"],   errors="coerce")
            g = g.dropna(subset=["start_date_parsed","due_date_parsed"])
            if g.empty:
                st.info("ìœ íš¨í•œ ë‚ ì§œ ë²”ìœ„ê°€ ìˆëŠ” ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.")
            else:
                fig = px.timeline(
                    g, x_start="start_date_parsed", x_end="due_date_parsed",
                    y="title", color="status", hover_data=["assignee","priority","labels"]
                )
                fig.update_yaxes(autorange="reversed")
                fig.update_layout(margin=dict(l=0, r=0, t=24, b=0))
                st.plotly_chart(fig, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ Comments â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_comments:
    st.subheader("ì½”ë©˜íŠ¸")
    mode = st.radio("ëŒ€ìƒ", options=["Project","Task"], horizontal=True, key=k("comment","mode"))
    entity_df = df_p if mode == "Project" else df_t
    if entity_df.empty:
        st.info("ë¨¼ì € ëŒ€ìƒ ë°ì´í„°ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.")
    else:
        id_col = "project_id" if mode == "Project" else "task_id"
        if mode == "Project":
            options_list = safe_select_options(df_p["project_id"])
            fmt = safe_fmt_by(df_p, "project_id", "name")
            entity_id = st.selectbox("Project ì„ íƒ", options=options_list, key=k("comment","entity","project"),
                                     format_func=lambda x: f"#{_s(x)} {fmt(x)}")
        else:
            options_list = safe_select_options(df_t["task_id"])
            fmt = safe_fmt_by(df_t, "task_id", "title")
            entity_id = st.selectbox("Task ì„ íƒ", options=options_list, key=k("comment","entity","task"),
                                     format_func=lambda x: f"#{_s(x)} {fmt(x)}")
        st.markdown("**ì½”ë©˜íŠ¸ ì¶”ê°€**")
        author = st.text_input("Author", key=k("comment","author"))
        body   = st.text_area("Body", height=120, key=k("comment","body"))
        if st.button("ë“±ë¡", key=k("comment","add")):
            if not body:
                st.error("BodyëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.")
            else:
                new_id, df_m = _next_id(df_m, "comment_id_seq")
                df_c.loc[len(df_c)] = {
                    "comment_id": new_id, "entity_type": mode.lower(), "entity_id": entity_id,
                    "author": author, "body": body, "created_at": _now_iso()
                }
                _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                st.success("ì½”ë©˜íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.")
                st.rerun()
        st.markdown("---")
        st.markdown("**ì½”ë©˜íŠ¸ ëª©ë¡**")

        show = df_c[(df_c["entity_type"].astype(object).map(_s).str.lower()==mode.lower()) & (df_c["entity_id"].astype(object).map(_s)==_s(entity_id))]
        st.dataframe(show.sort_values("created_at", ascending=False), width='stretch', height=400, hide_index=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€ Import/Export â”€â”€â”€â”€â”€â”€â”€â”€â”€
with tab_import:
    st.subheader("Import / Export")
    st.markdown("**ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì•ˆë‚´** â€” í˜„ì¬ í´ë”ì˜ 'pms_data.xlsx'ê°€ ìµœì‹  ë°ì´í„° íŒŒì¼ì…ë‹ˆë‹¤.")
    if st.button("ì „ì²´ ì‹œíŠ¸ Export (ì•Œë¦¼)", key=k("export","btn")):
        st.success(f"ê°™ì€ í´ë”ì˜ '{DATA_FILE}' íŒŒì¼ì„ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ì´ íŒŒì¼ì´ ìµœì‹  ë°ì´í„°ì…ë‹ˆë‹¤.")
    st.markdown("---")
    st.markdown("**ì‘ì—… ëŒ€ëŸ‰ ì—…ë¡œë“œ (CSV)** â€” ì»¬ëŸ¼ ì˜ˆì‹œ: project_id,title,description,assignee,priority,status,start_date,due_date,estimate_days,labels,progress(ì„ íƒ)")
    up = st.file_uploader("CSV íŒŒì¼ ì„ íƒ", type=["csv"], key=k("tasks","csv","upload"))
    if up is not None:
        try:
            up_df = pd.read_csv(up)
            for col in ["project_id","title","start_date","due_date"]:
                if col not in up_df.columns:
                    st.error(f"í•„ìˆ˜ ì»¬ëŸ¼ '{col}' ì´(ê°€) ì—†ìŠµë‹ˆë‹¤.")
                    up_df = None
                    break
            if up_df is not None and st.button("ì—…ë¡œë“œ ì ìš©", key=k("tasks","csv","apply")):
                cnt = 0
                skipped = 0
                for _, r in up_df.iterrows():
                    pid = _s(r.get("project_id",""))
                    if not pid:
                        skipped += 1; continue
                    # ë‚ ì§œ ìœ íš¨ì„±: due >= start (CSVì—ë„ ê°•ì œ)
                    sd = _parse_date_maybe(r.get("start_date",""))
                    dd = _parse_date_maybe(r.get("due_date",""))
                    if sd is None or dd is None or dd < sd:
                        skipped += 1; continue
                    new_tid = _next_project_task_id(df_t, pid)
                    df_t.loc[len(df_t)] = {
                        "task_id": new_tid,
                        "project_id": pid,
                        "parent_task_id": "",
                        "title": _s(r.get("title","")),
                        "description": _s(r.get("description","")),
                        "assignee": _s(r.get("assignee","")),
                        "priority": _s(r.get("priority","Medium")),
                        "status": _s(r.get("status","To Do")),
                        "start_date": _safe_date_str(sd),
                        "due_date": _safe_date_str(dd),
                        "estimate_days": float(pd.to_numeric(r.get("estimate_days", 0.0), errors="coerce") or 0.0),
                        "labels": _s(r.get("labels","")),
                        "progress": int(pd.to_numeric(r.get("progress", 0), errors="coerce") or 0)
                    }
                    cnt += 1
                _write_all(df_p, df_t, df_c, df_m, df_ct, df_bl, df_cf, df_hr, df_ts)
                st.success(f"{cnt}ê±´ì˜ ì‘ì—…ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. (ë¬´ì‹œ {skipped}ê±´: ë‚ ì§œ ëˆ„ë½/ì—­ì „ ë“±)")
                st.rerun()
        except Exception as e:
            st.error(f"ì—…ë¡œë“œ ì‹¤íŒ¨: {e}")
